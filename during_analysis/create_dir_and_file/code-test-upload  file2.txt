/* Copyright (C) 2012 Microsoft Corporation */(function(){var b=window,y=b.wLive,x=b.$Config,a,q=0,e=1,r=2,i=3,w="undefined",h="ready",o="unload",n="wlxcontacts",c="ContactPickerCore",u="ContactPickerShim",v=1,t=2,j=3,l=4,f,d;function s(){var ab=this,p=[],o=[],P,H,R=[],F=0,S=0,D=0,k=0,m=[],h,g=0,U=false,A=false,Q=false,L=false,M=false,T=false,n=y.Contacts.WLXContactsSchema,J=n.category,Z=J.id,xb=J.name,wb=J.isFavorite,I=n.group,yb=I.id,ub=I.name,ob=I.hexCid,f=n.person,K=f.id,sb=f.firstName,vb=f.lastName,pb=f.isFavorite,W=f.nickName,s=f.contacts,Bb=f.cid,zb=f.cid,Y=f.emails,eb=f.passportMemberName,X=n.contact,V=X.sourceId,kb=X.contactState,Ab=n.email;ab.buildContactData=function(){var a=b["ComposePage"];if(!(a&&a.contactList.onDemand))O();$Do.when(c,0,N)};ab.dispose=function(){$Do.remove(c,0,N)};function N(){var a=b[c];O();if(H){a.contactData=o;a.emailWhiteList=R.join("");a.personCount=D;a.categoryCount=S;a.groupCount=F;a.contactCount=D+F;a.maxRecordsReached=g&&k>=g;a.lock=false}}function tb(){h=x[u]||b[c]||{};H=h["cacheEnabled"]||false;g=h["maxRecords"]||0;U=h["hideEmails"]||false;A=h["emitOnlyHexCid"]||false;Q=h["isLastNameFirst"]||false;L=h["emitOnlyGuidForServerSideId"]||false;M=h["excludePersonsWithoutEmail"]||false;T=h["hideMeContact"]||false}function O(){if(P)return;tb();if(H){nb(a.persons);C(B);var b=0;for(b=0;b<o.length;b++){var d=o[b],c=d[1];m[c]=b}qb(a.groups);C(B);hb(a.categories);C(B);P=true}}function B(a,b){return lb(a[2],b[2])}function C(a){p.sort(a);o.addRange(p);p=[]}function lb(c,d){var a=c.toLowerCase(),b=d.toLowerCase();if(a===b)return 0;else if(a>b)return 1;else return -1}function ib(b){var a=b[eb];if(d(a))for(var c=0,e=Ab.other;c<=e;c++)if(b[Y]){a=b[Y][c];if(!d(a))break}return a}function gb(e){var a=v,c=e[s];for(var b=0,f=c.length;b<f;b++)if(c[b][V]==="WL"){var d=c[b][kb];switch(d){case 3:a=j;break;case 4:a=t;break;case 5:a=l}}return a}function rb(a){var c=a[K]||null,b,e,f=a[sb]||"",g=a[vb]||"";if(Q)b=g+" "+f;else b=f+" "+g;b=b.trim();if(c&&E(m[c]))m[c]=k;if(d(b)){e=ib(a);if(!d(e))b=e;else return}var h=a[pb]||false;z(b,null,c,null,q,h,gb(a),a);if(!d(a[W]))R.push(a[W]);k++;D++}function jb(e){var f=false;for(var c=0,g=e[s].length;c<g;c++){var b=a.getContactHelper(e,c);if(!d(b.getPersonalEmail())||!d(b.getWorkEmail())||!d(b.getOtherEmail())||!d(b.getPassportMemberName())){f=true;break}}return f}function nb(e){var b,c;for(var d=0,f=e.length;d<f;d++){if(g>0&&k>=g)break;b=e[d];if(M&&!jb(b))continue;c=a.isMeContact(b);if(T&&c)continue;rb(b,c)}}function hb(j){var b,f,d,c;for(var h=0,n=j.length;h<n;h++){if(g>0&&k>=g)break;b=j[h];d=[];c=a.getPersonsByCategory(b[Z]);if(c!=null)for(var i=0,l=c.length;i<l;i++){f=c[i];if(!E(m[f[K]]))d.push(m[f[K]])}z(b[xb],null,b[Z],d,e,b[wb]||false);k++;S++}}function qb(e){var a,b,d;for(var c=0,f=e.length;c<f;c++){if(g>0&&k>=g)break;a=e[c];b=a[yb];if(A)b=a[ob];d=i;z(a[ub],"",b,null,d,false);k++;F++}}function z(h,l,q,t,c,v,u,k){var f,b=[],a=[];if(c!==e)f=[];if(!d(l)){f.push(G(l));b.push(l.charAt(0))}else if(k&&k[s]){var n=mb(k,f);if(n!=null)b.push(n)}if(!d(h))b.push(cb(h));var g="",o=b.join("").toLowerCase(),m=0,w=o.length,j;for(;m<w;m++){j=o.charAt(m);if(g.indexOf(j)===-1)g+=j}b=null;a.push(g);a.push(q!=null?q:0);a.push(G(h));if(c!==e){if(c===i)a.push(1);else if(c===r)a.push(2);else a.push(0);a.push(v?1:0);a.push(fb(u));a.push(f)}else a.push(t);p.push(a)}function mb(c,o){var k=[],f=c[s];if(f!=null){var m=[],l,h,i;for(var b=0,p=f.length;b<p;b++){var n=f[b];if(n[V]==="WL"){h=c[zb];i=c[Bb]}if(A){if(d(h))continue;contactID=h}else l=L||d(i)?a.getContactId(c,b):i;var g=[];if(!U){var e=a.getContactHelper(c,b);g=db([e.getPassportMemberName(),e.getPersonalEmail(),e.getWorkEmail(),,e.getOtherEmail()],m);if(g.length===0)continue}var j=bb(o,b,l,g);if(j!=null)k.push(j)}}return k.join("")}function cb(e){var b=e.split(" "),c="";for(var a=0,d=b.length;a<d;a++)if(b[a].length>0)c+=b[a].charAt(0);return c}function fb(a){return a&&(a===j||a===l)?1:0}function bb(h,j,g,b){var e=[],f=[],a;if(b!=null)for(var c=0,i=b.length;c<i;c++){a=b[c];if(!d(a)){f.push(G(a));e.push(a.charAt(0))}}h.push([g,f]);return e.join("")}function db(c,f){var b=null,a;if(c!=null){b=[];for(var e=0,g=c.length;e<g;e++){a=c[e];if(!d(a)&&!f.contains(a)){b.push(a);f.push(a)}}}return b}function d(a){return E(a)||a===null||a===""}function E(a){return typeof a===w}function G(a){return !d(a)?a.encodeHtml():a}}function m(){d=new s;d.buildContactData()}function k(){a=b["$WLXContacts"];if(a)if(a.isReady)m();else if(a.$self){f=1;a.$self.bind(h,g)}}function g(){a.$self.unbind(h,g);f=0;m()}function p(){$Do.remove(n,0,k);jQuery(b).unbind(o,p);if(f&&a.$self)a.$self.unbind(h,g);if(d)d.dispose()}$Do.when(n,0,k);jQuery(b).bind(o,p)})();(function(){var a=window.jQuery,f=window.wLive,d=window.sutra,g=window,r=a(g),jb=a(document),e=g.wLive.Controls,b=g.wLive.Core,L="fetch",t="write",G="photos",K="documents",T="shared",S="SetView",M="SelfView",Q="PdfView",fb="mru",m="live.shared.skydrive.",l=".UI_Popover",s="live.shared.marketinfo.",j="click",X="contextmenu",sb="scroll",rb="resize",v="keydown",R="selectstart",vb="blur",kb="mouseup",ab="mousedown",V="mouseenter",bb="mousemove",W="mouseleave",eb="mouseout",Y=$B.IE?"MSPointerDown":"touchstart",cb=$B.IE?"MSPointerMove":"touchmove",gb=$B.IE?"MSPointerUp":"touchend",hb=46,N=8,nb=13,ib=27,yb=113,db="input",lb="span",ob="div",ub="a",Z="visibility",pb="hidden",mb="visible",n="disabled",tb="title",xb="href",y="src",x="alt",o=true,k=false,O="",wb="#",qb=".",D=window["File"]&&(window["File"].prototype.slice||window["File"].prototype.mozSlice||window["File"].prototype.webkitSlice),w=$B.IE&&$B.V==10,A=b["SilverlightInstalled"]&&!$B.Firefox&&!w;b.SoftBlockEnum={};var U=b.SoftBlockEnum={MoveAction:0,RenameAction:1,DeleteAction:2};function h(a,b){if(a==b)return true;if(a==null||b==null)return false;return a.toLowerCase()==b.toLowerCase()}function q(a){return GetString(m+"shared."+a)}function c(a){return GetString(m+"pc."+a)}function u(a,b,d){if(a&&b){var c=!d||a.commands===b.commands&&a.name===b.name;return a.key===b.key&&a.modifiedDate===b.modifiedDate&&c}else return false}var P="ClickedSelected.Command.SkyDrive";var p=5e3;(function(){var i="change";b.ProcessItemSet=k;b.ProcessItemSet.updateEventName=i;b.ProcessItemSet.Type={Upload:1,Delete:2,Move:3,Copy:4};b.ProcessItemSet.State={Pending:1,Active:2,Completed:3,Error:4};var c=b.ProcessItemSet.State,g=0;function k(c){var a=this;b.ItemSet.apply(this);a.key=++g;a.v=0;a.type=0;a.state=0;a.completedCount=0;a.completed=false;a.startTime=null;a.completedTime=null;a.totalErrorCount=0;a.errorOrgin=null;a.errorCount=0;a.errorMessage=null;a.errorCode=null;a.progress=0;a.data=null;a.operation=null;a._parentCollection=c;a.isVisible=true;a._filters.push(h)}b.ProcessItemSet.prototype=new f.Core.ItemSet;var a=b.ProcessItemSet.prototype,j=b.ItemSet.prototype;function d(a,b,d){if(d)e(a,null,null,null,false);if(a._parentCollection){if(!a.completed&&b){a._parentCollection._updateCompletedCount(true);a.progress=100;a.state=c.Completed;a.completedTime=(new Date).getTime()}else if(a.completed&&!b){a._parentCollection._updateCompletedCount(false);a.state=c.Pending;a.completedTime=null}a.completed=b}}function e(a,b,g,f,e){if(e)d(a,false,false);if(a._parentCollection){if(!a.errorMessage&&b){a.state=c.Error;a._updateErrorCount()}else if(a.errorMessage&&!b){a.state=c.Pending;a._updateErrorCount()}a.errorMessage=b;a.errorCode=g;a.errorOrgin=f}}a.setCompleted=function(a){d(this,a,true)};a.setError=function(a,c,b){e(this,a,c,b,true)};a.invalidate=function(){var a=this;j.invalidate.call(a);a.v++;if(a._parentCollection)a._parentCollection.invalidate()};a.add=function(c){var a=this;a.startTime=(new Date).getTime();c._setParent(a);b.ItemSet.prototype.add.apply(a,[c])};a.removeAt=function(e,c){var a=this,d=a.get(e,c);if(d){d.setError(null);d.setCompleted(false)}b.ItemSet.prototype.removeAt.apply(a,[e,c]);if(a.completedCount==a.getCount(c))a.setCompleted(true)};a._updateCompletedCount=function(b){var a=this;a.completedCount+=b?1:-1;a.setCompleted(a.completedCount==a.getCount(true))};a._updateErrorCount=function(){var a=this,d=a.getCount(true);if(d>0){a.totalErrorCount=0;a.errorCount=0;for(var b=0;b<d;b++){var e=a.get(b,true);a.totalErrorCount+=e.totalErrorCount;if(e.totalErrorCount>0)a.errorCount++}}else{a.errorCount=0;a.totalErrorCount=a.state==c.Error?1:0}if(a._parentCollection)a._parentCollection._updateErrorCount()};a._setParent=function(a){var b=this;b._parentCollection=a};function h(a){switch(a.type){case b.ProcessItemSet.Type.Upload:return !a._parentCollection||!a._parentCollection._parentCollection&&a._parentCollection&&a.getCount(true)>0||a._parentCollection._parentCollection&&a.isVisible&&a.getCount(true)==0&&a._parentCollection;default:return !a._parentCollection||!a._parentCollection._parentCollection&&a._parentCollection&&a.getCount(true)>0||a.errorMessage&&a.isVisible&&a.getCount(true)==0&&a._parentCollection}}})();(function(){var f=b.ProcessErrorActionsManager={},d=b.ProcessErrorActions={NameConflictOverwrite:{id:1,text:c("ProcessWindow.NameConflictOverwrite"),rollupText:c("ProcessWindow.NameConflictOverwriteAll")},NameConflictRename:{id:2,text:c("ProcessWindow.NameConflictRename"),rollupText:c("ProcessWindow.NameConflictRenameAll")},Retry:{id:3,text:c("ProcessWindow.Retry"),rollupText:c("ProcessWindow.RetryAll")},Unlock:{id:4,text:c("ProcessWindow.Unlock"),rollupText:c("ProcessWindow.UnlockAll")},MoveUnlock:{id:4,text:c("ProcessWindow.MoveUnlock"),rollupText:c("ProcessWindow.MoveUnlockAll")},CopyUnlock:{id:4,text:c("ProcessWindow.CopyUnlock"),rollupText:c("ProcessWindow.CopyUnlockAll")},DeleteUnlock:{id:4,text:c("ProcessWindow.DeleteUnlock"),rollupText:c("ProcessWindow.DeleteUnlockAll")}},e={"1000":[d.NameConflictOverwrite,d.NameConflictRename],folder_1000:[d.NameConflictRename],"9001":[d.Unlock],Delete_9001:[d.DeleteUnlock],Move_9001:[d.MoveUnlock],Copy_9001:[d.CopyUnlock],up_1:[d.Retry]};f.getActionLinks=function(b,k){var a,d="";if(k)for(var j=0,l=b.getCount(true);j<l;j++){var c=b.get(j,true);if(c.errorCode)if(!a){a=c.errorCode;d=c.errorOrgin}else if(a!=c.errorCode){a=0;d="";break}}else{a=b.errorCode;d=b.errorOrgin}var h=null;if(a){var f=e[d+"_"+a]||e[a];if(f){h=[];for(var i=0;i<f.length;i++)h.push(g(f[i],b,k,a))}}return h};function g(c,b,d,f){var g=d?c.rollupText:c.text,e=a('<a href="#">'+g.encodeHtml()+"</a>");e.click(function(){var g=b.operation;if(d){var h=[];for(var a=0,i=b.getCount(true);a<i;a++){var e=b.get(a,true);if(e.errorCode==f)h.push(e)}g.handleErrorResolution(h,c)}else g.handleErrorResolution([b],c);return false});return e}})();(function(){b.ProcessRow=l;var k=c("ProcessWindow.DismissRow"),j=c("ProcessWindow.RowPendingText"),i=c("ProcessWindow.RowCompletedText"),h=c("ProcessWindow.RowUploadActiveText"),g=c("ProcessWindow.RowUploadActiveNoProgressText"),m='<div class="procr_cont"><div class="procr_dismissicon"><a href="#"></a>&nbsp;</div><div class="procr_infocont"><div class="procr_displayText"><span class="procr_text"></span></div><div class="procr_fileicon">&nbsp;</div><div class="procr_filename"></div><div class="c_clr"></div><div class="procr_errorText"><span class="procr_error"></span><span class="procr_erroroptions"></span></div></div><div class="c_clr"></div></div>',e=b.ProcessItemSet.State;function l(t){var q=this;q.$container=t;var c=a(m),z=a(".procr_fileicon",c),v=a(".procr_filename",c),s=a(".procr_displayText",c),u=a(".procr_errorText",c),A=a(".procr_error",c),p=a(".procr_text",c),o=a(".procr_erroroptions",c),l=a(".procr_dismissicon a",c);l.append(b.ImageStrip.getImage("ppGreyX",k));t.append(c);l.click(y);var n,r;d(c,"$Sutra.SkyDrive.ProcessWindowRow");d(l,"$Sutra.SkyDrive.ProcessWindowRowDismiss");q.render=function(a){if(r!=a.v){n=a;r=a.v;var d=a.data;v.html(d.name.encodeHtml());v.attr("title",d.name);z.html(f.Core.SkyDriveItemHelper.getIcon(a.data,16));w();if(a.errorMessage){c.addClass("procr_error");A.html(a.errorMessage.encodeHtml());o.empty();u.show();s.hide();x(a)}else{s.show();u.hide();c.removeClass("procr_error");switch(a.type){case b.ProcessItemSet.Type.Upload:switch(a.state){case e.Pending:p.html(j.format(a.progress));break;case e.Active:p.html((a.progress>=0?h:g).format(a.progress));break;case e.Completed:p.html(i.format(a.progress))}}}}};q.dispose=function(){l.unbind();o.find("a").unbind();o.empty();processItemSet=null};function w(){var a=n._parentCollection.getCount(true);if(a>1&&(!n.completed||n.errorMessage))l.show();else l.hide()}function y(){var a=n.operation;a.abort();return false}function x(d){o.empty();var a=b.ProcessErrorActionsManager.getActionLinks(d,false);if(a)for(var c=0;c<a.length;c++)o.append("&nbsp;&nbsp;").append(a[c])}}})();(function(){b.ProcessGroup=x;var e=b.ProcessItemSet.Type,u=40,v=c("expandicontooltip"),t=c("collapseicontooltip"),n=c("ProcessWindow.CopyMultipleFormat"),r=c("ProcessWindow.CopySingleFormat"),m=c("ProcessWindow.UploadMultipleFormat"),q=c("ProcessWindow.UploadSingleFormat"),l=c("ProcessWindow.DeleteMultipleFormat"),o=c("ProcessWindow.DeleteSingleFormat"),p=c("ProcessWindow.MoveMultipleFormat"),s=c("ProcessWindow.MoveSingleFormat"),w=c("ProcessWindow.DismissGroup"),j=c("ProcessWindow.RowCompletedText"),i="{0}",k=i.encodeHtml(),h="procg_indeter",y='<div class="procg_cont"><div class="procg_header"><div class="procg_rcol"><div class="procg_dismissicon"><a href="#"></a>&nbsp;</div><div class="procg_statusText"></div><div class="procg_progressBar"><img src="'+FilesConfig.foldersImgBaseUrl+'/progress-graystretch.gif" class="procg_progressBarBg">'+'<img src="'+FilesConfig.foldersImgBaseUrl+'/progress-indeterminatestretch.gif" class="procg_progressBarBgIndeterm">'+'<div class="procg_progressBarProg">'+'<img src="'+FilesConfig.foldersImgBaseUrl+'/progress-greenstretch-pulsing.gif" class="procg_progressBarProgDeterm">'+'<div class="procg_progressBarProgEndCap"></div>'+"</div>"+"</div>"+'<div class="c_clr"></div>'+"</div>"+'<div class="procg_lcol">'+'<div class="procg_expander"><a href="#"></a></div>'+'<div class="procg_displayText"><span></span></div>'+'<div class="c_clr"></div>'+"</div>"+'<div class="c_clr"></div>'+"</div>"+'<ul class="procg_rows"></ul>'+"<hr />"+"</div>";function g(b,a){b.css("visibility",a?"visible":"hidden")}function x(G,O,T){var z=this,P=f.Core.PageController.getInstance().getViewContext();z.$container=G;z.dismissable=true;var A=a(y),M=a(".procg_header",A),J=a(".procg_displayText span",A),E,C=a(".procg_progressBar",A),Y=a(".procg_progressBarProg",A),H=a(".procg_rows",A),F=a(".procg_expander a",A),B=a(".procg_dismissicon a",A),x=a(".procg_statusText",A);B.append(b.ImageStrip.getImage("ppGreyX",w));var I=a(b.ImageStrip.getImage("closedUp",v)),K=a(b.ImageStrip.getImage("openUp",t));F.append(I).append(K);I.hide();var L=true,c,N;F.click(W);B.click(X);var D={};G.append(A);d(A,"$Sutra.SkyDrive.ProcessWindowGroup");d(x,"$Sutra.SkyDrive.ProcessWindowGroupStatusText");d(J,"$Sutra.SkyDrive.ProcessWindowGroupDisplayText");d(C,"$Sutra.SkyDrive.ProcessWindowGroupProgressBar");d(F,"$Sutra.SkyDrive.ProcessWindowGroupExpander");d(B,"$Sutra.SkyDrive.ProcessWindowGroupDismiss");d(H,"$Sutra.SkyDrive.ProcessWindowRows");z.render=function(d){if(N!=d.v){c=d;N=d.v;var u=d.data,G=d.getCount(),f=d.getCount(true),t="";switch(d.type){case e.Copy:t=f>1?n:r;break;case e.Upload:t=f>1?m:q;break;case e.Delete:t=f>1?l:o;break;case e.Move:t=f>1?p:s}if(E)E.unbind();var z=f;if(f==1){var K=d.get(0,true);z=K.data.name}J.html(t.format(z,i).encodeHtml().replace(/\s/g,"&nbsp;").replace(k,'<a href="#"></a>'));E=a("a",J);var L=u.getDisplayName&&u.getDisplayName(b.PageController.getInstance().getViewContext())||u.name;E.html(L.encodeHtml());var I=P.actionManager.getAction("ViewItem",u);if(I)P.actionManager.setATagAction(I,E);R();if(d.completed){x.empty();x.text(j);x.show();C.hide();M.removeClass("procg_noErrText")}else{C.show();S();V()}if(T){F.hide();C.hide();H.hide();x.hide();g(B,false)}else{g(F,G>0);var A={};for(var y=0;y<G;y++){var w=d.get(y),h,v=w.key;if(D[v]){h=D[v];delete D[v]}else{h=new b.ProcessRow(a("<li></li>"));H.append(h.$container)}h.render(w);A[w.key]=h}Q(A)}}};z.updateProgressBar=function(a,b){Y.width(Math.ceil(a/b*u))};z.getFirstProcessRowError=function(){var d=null;for(var a=c.getCount()-1;a>=0;a--){var b=c.get(a);if(b.errorMessage){d=D[b.key];break}}return d};z.dispose=function(){E.unbind();F.unbind();Q(null);processItemSet=null};function R(){switch(c.type){default:case e.Copy:case e.Delete:case e.Move:if(c.errorCount>0&&c.completedCount+c.errorCount==c.getCount(true)){g(B,true);z.dismissable=true}else if(c.completedCount==c.getCount(true)){g(B,false);z.dismissable=true}else{g(B,false);z.dismissable=false}break;case e.Upload:if(c.completedCount==c.getCount())g(B,false);else g(B,true);z.dismissable=true}}function V(){var a=b.ProcessErrorActionsManager.getActionLinks(c,true);if(a&&c.errorCount>1&&c.errorCount+c.completedCount===c.getCount(true)){x.empty();x.show();C.hide();for(var d=0;d<a.length;d++)x.append("&nbsp;").append(a[d])}else if(c.errorCount>0){x.show();x.empty();x.html("&nbsp;");M.addClass("procg_noErrText");C.hide()}else{M.addClass("procg_noErrText");x.hide();C.show()}}function S(){if(c.type==e.Upload){var b=0,d=c.getCount();for(var a=0;a<d;a++){var f=c.get(a);b+=f.progress}z.updateProgressBar(b,d*100);G.removeClass(h)}else{if(!c.completed)G.addClass(h);else G.removeClass(h);z.updateProgressBar(1,1)}}function U(){O.preResizeWindow();if(L){I.show();K.hide();H.hide()}else{I.hide();K.show();H.show()}L=!L;O.resizeWindow()}function X(){var a=c.operation;a.abort();return false}function W(){U();return false}function Q(b){var a;for(var c in D){a=D[c];a.dispose();a.$container.remove()}D=b}}})();(function(){b.ProcessWindow=k;var j=b.ProcessItemSet.Type,e=b.ProcessItemSet.State,v=100,q=250,x=c("ProcessWindow.MinErrorsText"),y=c("ProcessWindow.ResizePhotosText"),t=c("ProcessWindow.TaskRunningConfirmation"),i=c("ProcessWindow.TasksRunningWarning"),w=c("ProcessWindow.HeaderProgressText"),h="live.shared.globalsettings.webim.client.",s="ImageStripConfig",o="ImageStrip.Close",m="ImageStrip.Minimize",n="ImageStrip.Restore",z='<div class="procw"><div class="procw_shad"></div><div class="procw_ui"><div class="procw_header"><div class="procw_headertext"></div><div class="procw_headerminimize"></div><div class="procw_headerclose"></div><div class="c_clr"></div></div><div class="procw_body"><ul class="procw_pgroups"></ul></div><div class="procw_resize"><input id="procw_resize" name="photoresize" type="checkbox" checked="checked" /><label for="procw_resize">'+y.format(FilesConfig.maxThumbnailSize)+"</label>"+"</div>"+"</div>"+"</div>",l=new b.ProcessItemSet,u=new k;b.ProcessWindow.getProcessItemSet=function(){return l};b.ProcessWindow.getInstance=function(){return u};b.ProcessWindow.getInstance().init(b.ProcessWindow.getProcessItemSet());function k(){var y=this,l=a(z);l.hide();var rb=a(".procw_header",l),G=a(".procw_headertext",l),U=a(".procw_pgroups",l),V=a(".procw_body",l),R=a(".procw_resize",l),sb=a(".procw_shad",l),W=a(".procw_ui",l),bb=a("input",l),A,D,I,H,B={},k,F,u=null,C=false,E=null,L=false,ab=0,cb=true,K=-1,eb=false,qb=$B.IE_M7?window:window.parent;a(qb.document.body).append(l);l.bind("mouseenter",ob).bind("mouseleave",pb);bb.bind("change",hb);d(l,"$Sutra.SkyDrive.ProcessWindow");d(rb,"$Sutra.SkyDrive.ProcessWindowHeader");d(U,"$Sutra.SkyDrive.ProcessWindowGroups");window.parent.$Network.fetchCSS(FilesConfig.bucket3CssLocation,function(){function a(){window.parent.$Do.when("wLive.Controls.DraggableWindow",0,ib)}if(FilesConfig.webImDraggableWindowUrl)window.parent.$Network.fetchScript(FilesConfig.webImStringsUrl,function(){window.parent.$Network.fetchScript(FilesConfig.webImDraggableWindowUrl,a,"webimui")},"window.live.shared.globalsettings.webim");else a()});y.init=function(c){k=c;H=a(k);H.bind(b.ProcessItemSet.updateEventName,lb);y.render(k)};y.render=function(f){if(!eb){X();if(f.getCount()>0){if(u){gb();l.show();Q();u.initialize()}N()}else{l.hide();J()}db();var e={};for(var g=0;g<f.getCount();g++){var c=f.get(g),d;if(B[c.key]){d=B[c.key];delete B[c.key]}else{d=new b.ProcessGroup(a("<li></li>"),y);U.prepend(d.$container)}d.render(c);e[c.key]=d}if(ab<k.totalErrorCount){if(C)S();if(!L)kb(e)}ab=k.totalErrorCount;Y();T(e);Z()}};y.dispose=function(){if(H){H.unbind();fb()}if(u)u.dispose();if(A){A.unbind();D.unbind();I.unbind()}T(null);u=null;k=null;H=null;J();l.empty();l.remove();r.unbind("unload",y.dispose);l=null;eb=true};y.resizeState=function(){return cb};y.preResizeWindow=function(){X()};y.resizeWindow=function(){Z()};r.bind("unload",y.dispose);$Do.when("$PF.attach",0,y.dispose);function pb(){L=false;if(k.getCount()>0)N();else J()}function ob(){L=true;J()}function N(){if(!E&&!L)E=setTimeout(jb,p)}function J(){if(E){clearTimeout(E);E=null}}function hb(){cb=bb[0].checked;if(confirm(c("ProcessWindow.UploadConfirmResize")))nb()}function nb(){for(var a=0;a<k.getCount();a++){var b=k.get(a);if(b.type==j.Upload){var c=b.operation;c.restartUpload()}}}function kb(d){for(var a=k.getCount()-1;a>=0;a--){var b=k.get(a);if(b.errorCount>0){var c=d[b.key].getFirstProcessRowError();if(c){V.animate({scrollTop:c.$container.offset().top-U.offset().top},q);break}}}}function Y(b){if(!C||b){for(var a=0,d=k.getCount();a<d;a++){var c=k.get(a);if(c.type==j.Upload){R.show();return}}R.hide()}}function jb(){if(k){var c=(new Date).getTime();for(var a=0;a<k.getCount(true);a++){var b=k.get(a,true);if(b.completedTime&&c-b.completedTime>=p){var d=b.operation;d.abort();a--}}E=null;N()}}function ib(){if(k){u=new g.parent.wLive.Controls.DraggableWindow(null,l[0],G[0]);y.render(k)}}function lb(){f.throttle("processWindowThrottle",v,mb,true)}function mb(){y.render(k)}function M(){if(F){F.dispose();F=null}}function db(){if(C){var a=k.totalErrorCount;if(a>0){M();G.html(x.format(a))}else if(k.completedCount==k.getCount()){M();G.html(w)}else{if(!F){G.empty();F=new b.ProcessGroup(G,y,true)}var c=k.getCount();if(c>0)F.render(k.get(c-1))}}else{M();G.html("&nbsp;")}}function T(b){var a;for(var c in B){a=B[c];a.dispose();a.$container.remove()}B=b}function fb(){while(k.getCount()>0){var a=k.get(0),b=a.operation;b.abort()}}function O(){if(k)for(var b=0;b<k.getCount(true);b++){var d=k.get(b,true);for(var c=0;c<d.getCount(true);c++){var a=d.get(c,true),f=a.state;if(a.state==e.Active||a.state==e.Pending)return true}}return false}function tb(){for(var c in B){var b=B[c];if(!b.dismissable)return false}var a=O();if(!a||a&&confirm(t)){fb();T({});l.hide()}}function X(){K=l.height()}function Z(){Q();if(u)u.restore()}function S(){if(u){if(C){A.show();D.hide();V.show();Y(true)}else{A.hide();D.show();V.hide();R.hide()}Q();C=!C;u.set_isMinimized(C);db();if(C)u.dock();else u.restore()}}function Q(){sb.height(W.height());l.height(W.height()+5);l.width(W.width()+5);if(K>0&&K>l.height()&&u){var a=parseInt(l.css("top"));u.setCurrentY(a-(K-l.height()))}}function gb(){if(!A){A=a(P(m));D=a(P(n));I=a(P(o));A.click(S);D.click(S);I.click(tb);D.hide();a(".procw_headerminimize",l).append(A).append(D);a(".procw_headerclose",l).append(I);d(D,"$Sutra.SkyDrive.ProcessWindowHeaderMinimize");d(A,"$Sutra.SkyDrive.ProcessWindowHeaderMinimize");d(I,"$Sutra.SkyDrive.ProcessWindowHeaderClose")}}function P(a){return $IS.CreateFromConfig(GetString(h+s),GetString(h+a),$Config.WebIM.imgBase)}$Do.when("$PF.attachPreMerge",0,function(){if(O()){if(confirm(i))$PF.allowMerge()}else $PF.allowMerge()});window.onbeforeunload=function(){if(O())return i}}})();(function(){b.BaseOperation=h;var k=0,i=0,l=q("LoadGenericError");function h(d,c){var a=this;if(d.length>0){a.id=++k;a._processItemSet=new b.ProcessItemSet;a._parentSet=b.ProcessWindow.getProcessItemSet();a._parentSet.add(a._processItemSet);a._processItemSet.type=a.getCollectionType();a._processItemSet.data=c;a._processItemSet.operation=a;a._targetItem=c;a._dataRequests=[];e(a,d);a._processItemSet.invalidate()}}var c=h.prototype;c.getRequestUrl=function(){return null};c.getOperationName=function(){return null};c.getRequestPriority=function(){return null};c.handleError=function(c,d){var b=this,a;if(c.error)a=f(b,c.error.message,d);else a=g(b,c,d);b.postProcessItems(a,false)};c.handleSuccess=function(c,b){var a=g(this,c,b);this.postProcessItems(a,false)};c.postProcessItems=function(c,b){if(c){var a=this;!b&&a._targetItem.expire(true);a._targetItem.invalidate()}};c.processSingleItemSuccess=function(){};c.processSingleItemError=function(){};c.processSingleItemResponse=function(a,c){var b=false,d=this,e=a.data;if(c.error){a.setError(c.error.message,c.error.code,d.getOperationName());b=d.processSingleItemError(a)}else{a.setCompleted(true);b=d.processSingleItemSuccess(a)}a.invalidate();return b};c.start=function(){var b=this;for(var a=0;a<b._dataRequests.length;a++){var c=b._dataRequests[a];c.start()}};c.abort=function(){var a=this;for(var b=0;b<a._dataRequests.length;b++){var c=a._dataRequests[b];c.abort()}a._processItemSet.clear();a._parentSet.removeAt(a._parentSet.indexOf(a._processItemSet,true),true);a._parentSet.invalidate()};c.batchSizeLimit=function(){return 1};c.requestTimeout=function(){return 3e4};c.getCollectionType=function(){return 0};c.processItemSet=function(){};c.handleErrorResolution=function(a,e){var c=this;switch(e.id){case b.ProcessErrorActions.NameConflictOverwrite.id:d(c,a,{nameConflict:1});break;case b.ProcessErrorActions.NameConflictRename.id:d(c,a,{nameConflict:2});break;case b.ProcessErrorActions.Unlock.id:d(c,a,{overrideLock:true})}};function d(g,b,f){var d=b.length;if(d>0){for(var c=0;c<d;c++){var a=b[c];a.setError(null);a.setCompleted(false);a.progress=0;a.invalidate()}e(g,b,f,true,true)}}function e(a,d,p,o,m){var e,l=a.batchSizeLimit(),g=Math.ceil(d.length/l),f={};for(var i=0;i<g;i++)f[i]=[];for(var c=0;c<d.length;c++){if(m)subProcessItemSet=d[c];else{var q=d[c];subProcessItemSet=new b.ProcessItemSet;subProcessItemSet.data=q;subProcessItemSet.operation=a;a._processItemSet.add(subProcessItemSet)}e=a.processItemSet(subProcessItemSet)||e;if(!subProcessItemSet.errorMessage)f[c%g].push(subProcessItemSet)}for(var h=0;h<g;h++){var n=f[h],k=j(a,n,p);a._dataRequests.push(k);if(o)k.start()}a.postProcessItems(e,true)}function j(c,e,j){var d={items:[]};a.extend(d,j||{});if(c._targetItem){d.targetId=c._targetItem.id;d.cid=c._targetItem.ownerCid;d.group=c._targetItem.group}for(var f=0;f<e.length;f++){var h=e[f],k=h.data;d.items.push(k.id)}var l="operation"+c.getCollectionType()+"id"+c.id+"dr"+i++,m=c.getRequestUrl(),g=new b.DataRequest(l,m,Object.toJSON(d),function(a){c.handleSuccess(a,e)},function(a){c.handleError(a,e)},c.requestTimeout(),c.getRequestPriority());return g}function f(e,f,d){var b=false;for(var c=0;c<d.length;c++){var a=d[c];b=e.processSingleItemError(a)||b;a.setError(f,0,e.getOperationName());a.invalidate()}return b}function g(j,c,b){var a=false;if(c.items&&c.items.length==b.length){var g={};for(var d=0;d<b.length;d++){var i=c.items[d];g[i.id.toUpperCase()]=i}for(var e=0;e<b.length;e++){var h=b[e],k=g[h.data.id.toUpperCase()];a=j.processSingleItemResponse(h,k)||a}}else a=f(j,l,b)||a;return a}})();(function(){b.CopyOperation=c;var d=FilesConfig.baseApiUrl+"CopyItems";function c(){b.BaseOperation.apply(this,arguments)}var a=c.prototype=new b.BaseOperation([],null);a.getOperationName=function(){return "Copy"};a.getRequestPriority=function(){return b.RequestPriorityEnum.CopyOperation};a.getRequestUrl=function(){return d};a.batchSizeLimit=function(){return 1};a.requestTimeout=function(){return 1.2e5};a.getCollectionType=function(){return b.ProcessItemSet.Type.Copy};a.processSingleItemSuccess=function(){return true};a.processSingleItemError=function(){};b.OperationManager.Current.register("Copy",function(d,a){var b=new c(a.items,a.targetItem);b.start()})})();(function(){b.MoveOperation=d;var c=b.SkyDriveItemHelper,e=FilesConfig.baseApiUrl+"MoveItems";function d(){b.BaseOperation.apply(this,arguments)}var a=d.prototype=new b.BaseOperation([],null);a.getOperationName=function(){return "Move"};a.getRequestPriority=function(){return b.RequestPriorityEnum.MoveOperation};a.getRequestUrl=function(){return e};a.batchSizeLimit=function(){return 40};a.requestTimeout=function(){return 6e4};a.getCollectionType=function(){return b.ProcessItemSet.Type.Move};a.postProcessItems=function(d,c){if(d){var a=this;if(a._processItemSet.getCount(true)>0){var e=a._processItemSet.get(0,true),b=e.data,f=b.getParent();if(!c)b.expire(true);b.invalidate()}!c&&a._targetItem.expire(true);a._targetItem.invalidate()}};a.processItemSet=function(b){var a=b.data,e=f.Core.PageController.getInstance().getViewContext(),g=e.actionManager.getAction("Move",a),d=true;if(g)!c.isMruQuery(a)&&!c.isSharedQuery(a)&&a.hideFromParentId(a.parentId);else{b.setError(q("LoadGenericError"),0,this.getOperationName());d=false}return d};a.processSingleItemSuccess=function(){return true};a.processSingleItemError=function(b){var a=b.data;if(!c.isMruQuery(a)&&!c.isSharedQuery(a))a.hideFromParentId(null);if(b.errorCode=="1000"&&a.folder)b.errorCode="folder_1000";return true};b.OperationManager.Current.register("Move",function(c,a){var b=new d(a.items,a.targetItem);b.start()})})();(function(){var a="Photo",d="Audio",c="Video",e={JPG:a,JPEG:a,JPE:a,GIF:a,PNG:a,BMP:a,TIFF:a,TIF:a,ICO:a,DIB:a,JFIF:a,JIF:a,JFI:a,WDP:a,MP3:d,WMA:d,M4A:d,WAV:d,AIFF:d,MID:d,AU:d,MPG:c,AVI:c,MP4:c,"3GP":c,WLMP:c,WMX:c,"DVR-MS":c,M1V:c,MOD:c,MP2:c,MPE:c,MPV:c,MPV2:c,MP2V:c,VOB:c,WM:c,QT:c,MM4P:c,MPA:c,FLV:c,MOV:c,MPEG:c,WMV:c,ASF:c,RAW:a,ARW:a,CR2:a,CRW:a,DCR:a,DNG:a,ERF:a,KDC:a,MRW:a,NEF:a,ORF:a,PEF:a,PTX:a,RAF:a,SRF:a,SR2:a,X3F:a,DOC:"Doc",DOCX:"Docx",DOCM:"Docm",DOT:"Dot",DOTM:"Dotm",DOTX:"Dotx",XLS:"Xls",XLL:"Xls",XLSX:"Xlsx",XLSB:"Xlsb",XLSM:"Xlsm",XLTX:"Xltx",XLT:"Xlt",XLAM:"Xlam",XLA:"Xla",XLTM:"Xltm",PPT:"Ppt",PPTX:"Pptx",PPS:"Pps",PPSX:"Ppsx",PPTM:"Pptm",POT:"Pot",PPSM:"Ppsm",POTX:"Potx",POTM:"Potm",PPAM:"Ppam",PPA:"Ppa",ONE:"One",ONETMP:"One",ONEBIN:"One",ONEPKG:"Onepkg",ONETOC2:"Onetoc2",MDB:"Mdb",ACCDB:"Mdb",MPP:"Mpp",PUB:"Pub",VSD:"Vsd",XPS:"Xps",TXT:"Txt",HWP:"Txt",HTML:"Html",HTM:"Html",MHTML:"Html",MHT:"Html",URL:"Html",XML:"Xml",RTF:"Rtf",EXE:"Exe",ZIP:"Zip",RAR:"Zip",PDF:FilesConfig.allowAdobePdfIcon?"Pdf":"Pdf_fallback",XSN:"Xsn",XAML:"Xaml"};b.SkyDriveItemHelper.convertExtToIconType=function(a){if(a.startsWith("."))a=a.substr(1);return e[a.toUpperCase()]||"Default"}})();(function(){b.Html5FileUpload=a;function a(c,g){var a=this;a.name=c.fileName||c.name;var f=a.name.lastIndexOf("."),d=false;a.extension=f>=0?a.name.substring(f):"";a.iconType=b.SkyDriveItemHelper.convertExtToIconType(a.extension);a.size=c.size;a.downlevel=false;a.canResizeOnClient=false;a.upType="h5";a.dragDrop=g;a.isLocked=false;function e(a,d){var b="";if(c.slice)if($B.Firefox&&$B.V==4||$B.Chrome&&$B.V==10)b=c.slice(a,d-a);else b=c.slice(a,d);else if(c.mozSlice)b=c.mozSlice(a,d);else if(c.webkitSlice)b=c.webkitSlice(a,d);return b}a.isFolder=function(f){var b=new FileReader;b.onload=function(){if(!d)if(!b.result&&!a.extension)f(true);else f(false)};b.onerror=function(){if(!d)f(true)};try{if(b.readAsArrayBuffer)b.readAsArrayBuffer(e(0,Math.min(1,c.size)));else b.readAsBinaryString(e(0,Math.min(1,c.size)))}catch(g){f(true)}};a.post=function(i,k,c,f,b,j){if(!d){var h="";if(c!=f)h=e(c,f);var g={};for(var a=0;a<b.length;a++)g[b[a]]=j[a];$Network.fetchXML(i,k,"POST",h,g)}};a.dispose=function(){d=true;c=null}}})();(function(){b.SLFileUpload=a;function a(c,d){var a=this,h=d;a.control=d;a.file=c;a.name=c.FileName;var g=a.name.lastIndexOf("."),e=false;a.extension=g>=0?a.name.substring(g):"";a.iconType=b.SkyDriveItemHelper.convertExtToIconType(a.extension);a.size=c.FileSize;var f=c.ParentResourceId.split(";");a.parentResourceId=f[0];a.ownerCid=f[1];a.group=f[2]=="1"?1:0;a.downlevel=false;a.canResizeOnClient=true;a.upType="sl";a.dragDrop=c.WasDragAndDropped;a.isLocked=c.IsLocked;a.isFolder=function(a){if(c)a(c.IsFolder)};a.post=function(i,j,h,k,f,g){if(!e){for(var a=0;a<f.length;a++){f[a]=f[a]+"";g[a]=g[a]+""}b.FileUploadManager.registerSLCallback(c.FileId,j);d.PostUpload(c.FileId,i,h,k-h,f,g)}};a.resize=function(f,h,g){if(!e){b.FileUploadManager.registerSLCallback(c.FileId,function(b){if(!e){a.size=b;g(b)}});if(h)d.ResetToOrginal(c.FileId,f);else d.ResizeImage(c.FileId,f)}};a.dispose=function(){if(c){e=true;d.RemoveFile(c.FileId);c=null;d=null}}}})();(function(){b.DownlevelFileUpload=a;function a(d){var a=this;if(d){var e=d.lastIndexOf("\\");d=e>=0&&e<d.length-1?d.substring(e+1):d}a.name=d||c("ProcessWindow.DownlevelUploadFileName");var f=a.name.lastIndexOf(".");a.extension=f>=0?a.name.substring(f):"";a.iconType=b.SkyDriveItemHelper.convertExtToIconType(a.extension);a.size=0;a.downlevel=true;a.canResizeOnClient=false;a.upType="dl";a.dragDrop=false;a.isLocked=false;a.isFolder=function(a){a(false)};a.dispose=function(){}}})();(function(){var p=FilesConfig.storageUploadBaseUrl,u=3,n=10*1024,x=2*1024*1024,j=1e3,r=4e3,o="",k="X-ClientErrorCode",d=n,m=FilesConfig.maxFileSize,s=m*1024*1024,l=1e3,a="ProcessWindow.UploadErrors.",i=c(a+"UploadGenericError"),q=c(a+"UploadFileSizeLimitError").format(m),z=0,w=0,y=new b.PriorityQueue(u),h=0,e=b.ProcessItemSet.State;b.SingleFileUpload=v;function v(I,ab,v){var m=this,F,C,B,T=0,L=false,H=false,R=false,G=false,E=0;m.id=z++;m.file=I;m.aborted=false;m.executing=false;m.pendingRestart=false;m._processItemSet=new b.ProcessItemSet;m._parentSet=ab;m._parentSet.add(m._processItemSet);m._processItemSet.type=b.ProcessItemSet.Type.Upload;m._processItemSet.state=e.Pending;m._processItemSet.data=I;m._processItemSet.operation=m;m._processItemSet.invalidate();m.start=function(){if(G||h<l){if(!G)h++;G=true;if(!m.aborted)if(this.file.downlevel){m._processItemSet.state=e.Active;m._processItemSet.progress=-1;m._processItemSet.invalidate()}else{E++;y.enqueue(function(a){E--;if(D()&&E==0){F=a;m.executing=true;Z();return true}else return false},function(){E--;m.abort()},1,"uploadqueue_"+m.id+"_"+T,"upload")}}else{m._processItemSet.setError(c(a+"FilesCountLimit").format(l),"up_filecountlimit");m._processItemSet.invalidate();m.file.dispose()}};m.abort=function(){if(!m.aborted){B=o;m.pendingRestart=false;m._parentSet.remove(m._processItemSet);m._parentSet.invalidate();m._processItemSet=null;m._parentSet=null;m.file.dispose();A();u();if(G)h--}m.aborted=true};m.handleErrorResolution=function(c,a){switch(a.id){case b.ProcessErrorActions.NameConflictRename.id:H=true;m.restartUpload();break;case b.ProcessErrorActions.NameConflictOverwrite.id:H=false;L=true;m.restartUpload();break;case b.ProcessErrorActions.Retry.id:m.restartUpload()}};m.setDownlevelStatus=function(a){switch(a){case "Success":m._processItemSet.setCompleted(true);O();m._processItemSet.invalidate();break;default:P(a,true)}};m.restartUpload=function(){if(!m.executing&&!m.file.downlevel){if(R||m._processItemSet.state==e.Completed){H=false;L=true}T++;m._processItemSet.setCompleted(false);m._processItemSet.setError(null);m._processItemSet.state=e.Pending;m._processItemSet.progress=0;m._processItemSet.invalidate();m.start()}else m.pendingRestart=true};function X(){if(m.pendingRestart){A();u();m.pendingRestart=false;m.restartUpload();return true}else return false}function D(){return !m.aborted&&!X()}function A(){if(C){C();C=null}}function u(){if(F){m.executing=false;F();F=null}}function Q(a){if(a)d=Math.min(d*2,x);else d=Math.max(d/2,n)}function U(){if(v.id=="root")return p.format(v.ownerCid)+"/users/0x"+v.ownerCid+"/LiveFolders/"+m.file.name.encodeURIComponent();else return p.format(v.ownerCid)+"/items/"+v.id+"/"+m.file.name.encodeURIComponent()}function P(f,d){var b,e;switch(f){case "InsufficientSpaceAvailable":case "QuotaLimitReached":b=c(a+"UploadQuotaLimitReached");break;case "BadArgument":case "InvalidPath":b=c(a+"UploadInvalidFileName");break;case "UsageRestricted":case "AccessDenied":b=c(a+"UploadAccessDenied");break;case "RelationshipNameAlreadyExists":case "ItemAlreadyExists":b=c(a+(d?"DLUploadNameConflict":"UploadNameConflict"));e=d?"dl1000":"1000";break;default:b=i;e=d?"up_dl_1":"up_1"}m._processItemSet.setError(b,e);m._processItemSet.invalidate()}function N(a){a=a||{};P(a[k],false);u()}function J(c,a,h,i,e){if(B){c.push("BITS-Session-Id");a.push(B)}c.push("Application");a.push("LiveFolders");c.push("Accept");a.push("application/wls-response-headers+json");c.push("X-Http-Method-Override");a.push("BITS_POST");c.push("Overwrite");a.push(H?"choosenewname":L);if(b.ProcessWindow.getInstance().resizeState()){c.push("X-PhotoSizeConstraint");a.push(FilesConfig.maxThumbnailSize+"x"+FilesConfig.maxThumbnailSize)}var d=[];d.push("upType="+I.upType);d.push("dragDrop="+I.dragDrop);c.push("X-RequestStats");a.push(d.join(","));function f(){if(!m.aborted)m.file.post(U(),function(b){var c=b.responseText,a=Object.fromJSON(c);if(a&&(a["StatusCode"]==200||a["StatusCode"]==201)){e(a);A()}else{e(a,true);A()}},h,i,c,a);else A()}g.requests.enqueue(function(a){C=a;f();return true},function(){m.abort()},b.RequestPriorityEnum.UploadOperation,"uploadrequest_"+m.id+"_"+w++,t)}function M(b){var a=true;if(b)switch(b[k]){case "InsufficientSpaceAvailable":case "QuotaLimitReached":case "BadArgument":case "InvalidPath":case "UsageRestricted":case "AccessDenied":case "RelationshipNameAlreadyExists":case "ItemAlreadyExists":a=false;break;default:a=true}return a}function O(){var a=v;f.throttle("uploadInvalidate_"+v.id,r,function(){a.expire(true);a.invalidate()},true)}function V(d){var b={id:d};function a(){m._processItemSet.setCompleted(true);m._processItemSet.invalidate();O();u()}if(m.file.iconType=="Video"){m._processItemSet.progress=99;m._processItemSet.invalidate();var c={canary:FilesConfig.canary,Accept:"application/json",AppId:FilesConfig.appId},e=FilesConfig.baseApiUrl+"UpdateVideoMetadata/?canary="+FilesConfig.canary.encodeUrl();$Network.fetchXML(e,a,"POST",Object.toJSON(b),c)}else a()}function Y(){var b=3;function a(){var d=[],c=[];d.push("BITS-Packet-Type");c.push("Close-Session");var e=(new Date).getTime();J(d,c,0,0,function(d,c){f.PageStats.add({url:"Upload Close Session",error:c},e);R=!c;if(D())if(!c)V(d["X-Resource-Id"]);else if(b-->0&&M(d,c))setTimeout(a,j);else N(d)})}a()}function W(){var a=0,b=Math.min(a+d,m.file.size),f=true,e=3;function c(f,g){if(!g)if(b==m.file.size)Y();else{e=3;Q(true);a=b;b=Math.min(a+d,m.file.size);m._processItemSet.progress=Math.floor(a/m.file.size*100);m._processItemSet.invalidate();setTimeout(function(){K(a,b,c)},j)}else if(e-->0&&M(f,g)){Q(false);b=Math.min(a+d,m.file.size);K(a,b,c)}else N(f)}K(a,b,c)}function K(c,d,g){var b=[],a=[];b.push("BITS-Packet-Type");a.push("Fragment");b.push("Content-Range");a.push("bytes "+c+"-"+Math.max(0,d-1)+"/"+m.file.size);var e=(new Date).getTime();J(b,a,c,d,function(b,a){if(D()){f.PageStats.add({url:"Upload Fragment",error:a},e);g(b,a)}})}function Z(){var d=m.file;d.isFolder(function(e){if(e){m._processItemSet.setError(c(a+"UploadFolderError"),"up_folder");m._processItemSet.invalidate();u();return}else if(d.size&&d.size>s){m._processItemSet.setError(q,"up_limit");m._processItemSet.invalidate();u();return}else if(d.size==0){m._processItemSet.setError(i,"up_nosize");m._processItemSet.invalidate();u();return}else if(d.isLocked){m._processItemSet.setError(i,"up_filelocked");m._processItemSet.invalidate();u();return}if(d.canResizeOnClient)d.resize(FilesConfig.maxThumbnailSize,!b.ProcessWindow.getInstance().resizeState(),function(){S()});else S()})}function S(){var c=m.file;B=o;m._processItemSet.state=e.Active;m._processItemSet.invalidate();var b=3;function a(){var d=[],c=[];d.push("BITS-Packet-Type");c.push("Create-Session");d.push("BITS-Supported-Protocols");c.push("{7df0354d-249b-430f-820d-3d2a9bef4931}");var e=(new Date).getTime();J(d,c,0,0,function(c,d){if(D()){f.PageStats.add({url:"Upload Create Session",error:d},e);if(!d){B=c["BITS-Session-Id"];W()}else if(b-->0&&M(c,d))setTimeout(a,j);else N(c)}})}a()}}})();(function(){b.FileUploadManager=e;$Network.requiresDomainLowering(false);var c={},d={};function e(f){var a=this,d=[];a._processItemSet=new b.ProcessItemSet;a._parentSet=b.ProcessWindow.getProcessItemSet();a._parentSet.add(a._processItemSet);a._processItemSet.type=b.ProcessItemSet.Type.Upload;a._processItemSet.data=f.item;a._processItemSet.operation=a;e(f);a._processItemSet.invalidate();a.start=function(){for(var a=0;a<d.length;a++){var b=d[a];b.start()}};a.restartUpload=function(){for(var a=0;a<d.length;a++){var b=d[a];b.restartUpload()}};a.abort=function(){for(var b=0;b<d.length;b++){var c=d[b];c.abort()}d=[];a._processItemSet.clear();a._parentSet.removeAt(a._parentSet.indexOf(a._processItemSet,true),true);a._parentSet.invalidate()};$Do.register("CancelChunkedUploads",a.abort);a.addUploads=function(f){var b=d.length;e(f);for(var a=b;a<d.length;a++){var c=d[a];c.start()}};a.handleErrorResolution=function(b,e){for(var a=0;a<b.length;a++){var c=b[a],d=c.operation;d.handleErrorResolution([c],e)}};function e(e){if(e.files){var h=e.files;for(var f=0;f<h.length;f++){var l=new b.Html5FileUpload(h[f],e.wasDragAndDropped),j=new b.SingleFileUpload(l,a._processItemSet,e.item);d.push(j)}}else if(e.slFile){var m=new b.SLFileUpload(e.slFile,e.control);a._processItemSet.data=e.slDataItem;var i=new b.SingleFileUpload(m,a._processItemSet,e.slDataItem);d.push(i)}else if(e.dlFile){var k=new b.DownlevelFileUpload(e.fileName),g=new b.SingleFileUpload(k,a._processItemSet,e.item);d.push(g);c[e.dlFile]=g}}}var a={};$Do.register("FileUploadManagerPost",function(b){if(a[b.fileId]){var f=a[b.fileId],c,d=b.newSize;if(d!==undefined)c=d;else{var e={StatusCode:b.statusCode};c={responseText:b.responseText?b.responseText:Object.toJSON(e),status:b.statusCode}}delete a[b.fileId];f(c)}});e.registerSLCallback=function(c,b){a[c]=b};$Do.register("FileUploadManager",function(a){if(a.dlFile&&a.status){var f=c[a.dlFile];if(f){f.setDownlevelStatus(a.status);c[a.dlFile]=null}}else if(a.slFile&&a.slFile.SessionId&&d[a.slFile.SessionId]){var e=d[a.slFile.SessionId];if(e)e.addUploads(a)}else{var g=new b.FileUploadManager(a);g.start();if(a.slFile&&a.slFile.SessionId)d[a.slFile.SessionId]=g}})})();(function(){b.DeleteOperation=c;var d=FilesConfig.baseApiUrl+"DeleteItems";function c(){b.BaseOperation.apply(this,arguments)}var a=c.prototype=new b.BaseOperation([],null);a.getOperationName=function(){return "Delete"};a.getRequestPriority=function(){return b.RequestPriorityEnum.DeleteOperation};a.getRequestUrl=function(){return d};a.batchSizeLimit=function(){return 40};a.requestTimeout=function(){return 6e4};a.getCollectionType=function(){return b.ProcessItemSet.Type.Delete};a.processItemSet=function(a){var b=a.data;b.setVisibility(false);return true};a.processSingleItemSuccess=function(b){var a=b.data;a.expire();a.invalidate();return true};a.processSingleItemError=function(a){var b=a.data;b.setVisibility(true);return true};b.OperationManager.Current.register("Delete",function(d,a){var b=new c(a.items,a.targetItem);b.start()})})();(function(){var d=b.ItemActionHelper;b.DownloadAsZipOperation=c;var f=250,e=20;function c(c){var j=this,b;j.start=function(){h()};function i(){return a('<iframe src="'+FilesConfig.iFrameEmptyUrl.encodeHtmlAttribute()+'"></iframe>').hide().appendTo(g.document.body)}function h(){if(!b)b=i();if(c.length==1&&window.navigator&&window.navigator.userAgent&&window.navigator.userAgent.toLowerCase().indexOf("msn 9.0")>0){var k=d.itemStringFormat("/downloadfolder.aspx?{cidQueryString}{resIdQueryString}&canary={FilesConfig.navCanary:encodeURIComponent}",c[0]);b.attr("src",k);return}var l=d.itemStringFormat("/downloadasziplanding?canary={FilesConfig.navCanary:encodeURIComponent}",null),j=[];for(var a=0;a<c.length;a++){var m=c[a];j.push(m.id)}b.attr("src",l);var g=e;function h(){try{if(g>0)b[0].contentWindow.startDownloadAsZip(j.join(";"),FilesConfig.navCanary)}catch(a){g--;setTimeout(h,f)}}h()}}b.OperationManager.Current.register("DownloadAsZip",function(d,b){var a=new c(b.items);a.start()})})();(function(){var f=0,i=1.8e6;d.Role={Owner:-1,View:1,Edit:2};d.GroupRole={View:0,Edit:1};d.EntityType={Email:0,User:1,Group:2,Link:3,Public:4,Friends:5,GroupOwned:99};d.LinkType={Network:1,Embed:3,View:5,Edit:6};b.PermissionsProvider=d;function d(A){var i=this,z=A,j=b.SkyDriveItemHelper.isRootItem,k=b.SkyDriveItemHelper.getTopLevelItem;i.hasCachedData=function(a){return v(a)===undefined};i.deletePermission=function(d,a,c,b){a.role=f;this.updatePermissions(d,a,{suppressNotification:true},c,l(b))};i.embedLink=function(e,b,a){var c={role:d.Role.View,type:d.EntityType.Link,linkType:d.LinkType.Embed};this.updatePermissions(e,c,null,b,l(a))};i.makePublic=function(e,b,a){var c={role:d.Role.View,type:d.EntityType.Public};this.updatePermissions(e,c,null,b,l(a))};i.createLink=function(f,a,c,b){var e={role:a,type:d.EntityType.Link,linkType:a==d.Role.Edit?d.LinkType.Edit:d.LinkType.View};this.updatePermissions(f,e,null,c,l(b))};i.shareToContacts=function(i,o,v,s,u,r,e){var h=[],t=a("<div></div>"),m,l;for(var k=0;k<o.length;k++){var b=o[k],q=FilesConfig.managedAccount&&!b.isGroup&&!b.serverSideContactID;if(q){l=true;break}if(b.isValid===false){m=true;break}var f=b.serverSideContactID;if(f&&f.indexOf("-")>-1)f=null;var j=b.isGroup?d.EntityType.Group:f?d.EntityType.User:d.EntityType.Email,g={role:v,type:j},n=b.email;if(n)g.email=t.html(n).text();if(j==d.EntityType.User)g.did=f;else if(j==d.EntityType.Group)g.abId=b.serverSideID;h.push(g)}if(l)e&&e(i,{message:c("Sharing.ManagedAccountMessage")});else if(m||h.length==0)e&&e(i,{message:c("Sharing.ShareErrorAllFailed")});else p(i,h,u,s,false,null,null,r,e)};i.shareToNetworks=function(k,c,h,i,f,e){var b=[];for(var a=0;a<c.length;a++){var j=c[a],g={role:h,type:d.EntityType.Link,linkType:d.LinkType.Network,linkName:j.id};b.push(g)}p(k,b,i,null,false,null,null,f,e)};i.updatePermissions=function(g,a,e,c,f){var b=a.type==d.EntityType.GroupOwned;delete a.link;p(g,b?[]:[a],null,null,b,b?a.role:null,e&&e.suppressNotification,function(i,e){var g;if(e)for(var f=0;f<e.length;f++){var d=e[f];if(a.linkType===d.linkType&&a.role===d.role&&a.type===d.type&&(a.id==null||h(a.id,d.id)))g=e[f]}c&&c(i,b?a:g)},f)};i.fetchPermissions=function(a,d,f,j){var h=!j&&t(a);if(h)d(a,h);else{var e=v(a),c={id:a.id,v:Math.random(),mkt:$Config.mkt};if(a.ownerCid)c.cid=a.ownerCid;if(b.SkyDriveItemHelper.isGroupItem(a))c.group=a.group;if(e)c.itemOnly=e;var i=g.FilesConfig.baseApiUrl+"GetPermissions?"+$Utility.serialize(c),k=new b.DataRequest(i,i,null,function(c){u(a,c,e);var b=t(a,true);d&&d(a,b)},function(b){f&&f(a,b.error)});k.start()}};function l(a){return function(e,d,c){var b=c&&c[0];if(b)d.code=b.code;a&&a(e,d)}}function p(a,k,j,h,n,m,d,f,e){var c={id:a.id,entities:k};if(h!==null)c.requireSignIn=h;if(n){c.group=1;c.groupUserRole=m;c.ownerCid=a.ownerCid}if(j)c.message=j;if(d!==null)c.suppressNotification=d;var l=Object.toJSON(c),p=g.FilesConfig.baseApiUrl+"SetPermissions",o=new b.DataRequest(null,p,l,function(e){var c=e.permissions,b=c&&c.permissionScopes,d=b&&b[0]&&b[0].entities;u(a,c);a.expire(false);a.invalidate();f&&f(a,d)},function(b){if(b.errorResult)i.fetchPermissions(a,function(){a.expire(false);a.invalidate()},null,true);e&&e(a,b.primaryError?b.primaryError:b.error,b.errorResult)});o.start()}function m(a){return {id:a.id,name:a.name,entities:[]}}function n(d,f,e,g){var a=f.permissionScopes;for(var b=0;b<a.length;b++)if(a[b].id==d.id){if(!g)return a[b];return a.splice(b,1)[0]}if(e){var c=m(d);a.push(c);return c}return null}function y(b,c){var a;if(!b["getParent"]){a=n(b,c,false,true);if(a)c.permissionScopes.unshift(a);return}var d=[];while(b){a=n(b,c,false,true);if(a)d.push(a);b=b.getParent(true)}c.permissionScopes=d.concat(c.permissionScopes)}function x(b,a){a.permissionScopes=a.permissionScopes||[];y(b,a);var c=a.permissionScopes,e=c[0];if(c.length==0||!h(e.id,b.id)){e=m(b);c.splice(0,0,e)}if(a.group||!q(b)){var g,f;if(a.group){var i=k(b);g=n(i,a,true);f={role:a.groupUserRole,type:d.EntityType.GroupOwned}}else{g=c[0];f={did:b.ownerDCid,id:a.ownerCid,name:a.ownerName,role:d.Role.Owner,type:d.EntityType.User}}g.entities.unshift(f);return}}function u(b,g,f){x(b,g);if(r(b)){w(b,g);return}if(f===undefined)f=false;var d=g.permissionScopes,h={};for(var i in g)if(i!=="permissionScopes")h[i]=g[i];var a=b,c;a:for(c=0;a&&!j(a)&&c<d.length;c++){var l=false;while(a&&!j(a)){l=false;if(d[c].id===a.id){a._permissionScope=new e(d[c]);l=true}else a._permissionScope=new e(m(a));if(f)break a;a=a.getParent(true);if(l)break}}if(c<d.length&&!f){var p=d.splice(c,d.length-c);k(b)._cappedPermissions=p}else if(o(b))k(b)._cappedPermissions=[];while(a&&!j(a)&&!f){a._permissionScope=new e(m(a));a=a.getParent(true)}var n=new e(h);b._permissionExtra=n;if(!h["group"]&&!f){a=b.getParent(true);while(a&&!j(a)){a._permissionExtra=n;a=a.getParent(true)}}}function t(a,f){if(r(a))return s(a,f);var d=a._permissionExtra;if(!d||!f&&d.isExpired())return null;var c={};for(var i in d.value)c[i]=d.value[i];c.permissionScopes=[];var b=a;while(b&&!j(b)){var e=b._permissionScope;if(!e||!f&&e.isExpired())return null;var h=e.value;if(h.entities.length>0||b==a)c.permissionScopes.push(h);b=b.getParent(true)}if(o(a)){var g=k(a);if(g._cappedPermissions&&g._cappedPermissions.length>0)c.permissionScopes=c.permissionScopes.concat(g._cappedPermissions)}return c}function v(c){if(r(c))return s(c)?undefined:false;if(o(c)){var h=k(c);if(!h._cappedPermissions)return false}var d=-1,e=0,a=c;while(a&&!j(a)){var g=a._permissionScope;if(!g||g.isExpired())d=e;else{var f=a._permissionExtra;if(a===c&&(!f||f.isExpired()))d=e}if(d>0)break;a=a.getParent(true);e++}if(d===-1)return undefined;if(b.SkyDriveItemHelper.isGroupItem(c))return false;return !d}function s(c,b){var a=c._simplePermissions;if(!a||!b&&a.isExpired())return null;return a.value}function w(b,a){b._simplePermissions=new e(a)}function r(a){return !a["getParent"]||!a.group&&!q(a)}function o(a){return (a.isQt("mru")||a.isQt("shared"))&&q(a)}function q(a){return h(z,a.ownerCid)}}function e(a){this.value=a;this.expires=(new Date).getTime()+i;this.isExpired=function(){return this.expires<(new Date).getTime()}}})();(function(){var e=1,d;c.Status={None:0,Connected:1,Error:2};b.NetworksProvider=c;function c(){var j=this,i,h=[],f=[];j.clearCache=function(){d=null};j.fetchNetworks=function(a,c){if(d)a&&a(d.networks);else{if(a)h.push(a);if(c)f.push(c);if(!i){i=true;var k={resultSet:e},j=g.FilesConfig.baseApiUrl+"GetNetworks?"+$Utility.serialize(k),m=new b.DataRequest(j,j,null,function(a){i=false;d=a;l(h,d.networks);h=[];f=[]},function(a){i=false;var b=a&&a.error;l(f,b);h=[];f=[]});m.start()}}};function l(b,d){for(var a=0;a<b.length;a++){var c=b[a];try{c&&c(d)}catch(e){}}}j.getConnectedNetworks=function(d){var b=k(d,c.Status.Connected),e=k(d,c.Status.Error);a.merge(b,e);return b};j.getUpsellNetworks=function(a){return k(a,c.Status.None)};function k(c,f){var b=[],e=c.length;for(var a=0;a<e;a++){var d=c[a];if(d.status==f)b.push(d)}return b}}})();(function(){var g="SharingListTemplate",i="SharingListExpandedTemplate";e.PermissionScopeControl=k;function k(m,s,r,e,k,u,n,x,w){var p=c("Sharing.ScopeHeaderFormat"),z=this,q={};z.render=function A(p){var b=a('<li class="ips_scope"></li>');r.append(b);d(b,"$Sutra.SkyDrive.InfoPaneSharingScope");if(!h(e.id,k.id)&&!u&&n)t(b);var c=a("<ul></ul>");b.append(c);d(c,"$Sutra.SkyDrive.InfoPaneSharingEntities");var m=[],j=0;for(var f=0;f<k.entities.length;f++)if(n||j<p){v(m,c,k.entities[f]);j++}$ic.ic.createICsFromCids(n?i:g,m,y,o);if(r.closest(l).length)a(".ips_ic_remove:first").focus()};function v(g,d,c){var a=new f.Controls.PermissionEntityControl(c,e,s,d,n,x,w);a.render();var b=a.getIcId();if(b){q[b]=a;g.push([c.did,b])}}function t(l){if(!FilesConfig.isWacSharing&&!((e.isQt("mru")||e.isQt("shared"))&&h(m.callerCid,e.ownerCid))){var r=b.SkyDriveItem.getItemKey(k.id,e.ownerCid,e.group),c=m.dataModel.getItem(r,true),q=c?'<a href="#" class="ips_scope_link"></a>':'<span class="ips_scope_link"></span>',t='<div class="ips_scope_header">'+p.format(q)+"</div>",f=a(t),g=a(".ips_scope_link",f);g.text(k.name);if(c)g.bind(j,function(){m.selectionManager.deselectAll()});l.append(f);d(f,"$Sutra.SkyDrive.InfoPaneSharingScopeHeader");if(c){var o=m.actionManager.getAction("ViewItem",c);m.actionManager.setATagAction(o,g,m.infoPaneBiciLoc)}}else{var i="/?cid="+e.ownerCid.encodeUrl()+"&id="+k.id.encodeUrl();if(e.group)i+="&group="+e.group;var n='<a href="'+i.encodeHtmlAttribute()+'">'+k.name.encodeHtml()+"</a>",s='<div class="ips_scope_header">'+p.format(n)+"</div>";l.append(a(s))}}function y(c,b){var a=q[c];if(a)if(b)a.icReady(b);else a.loadDefaultIc()}}})();(function(){var j=b.ImageStrip,h=b.PermissionsProvider,g=h.Role,l=h.GroupRole,f=h.EntityType,i=h.LinkType,k="SharingListTemplate",o="sharingListIc",n=FilesConfig.foldersImgBaseUrl+"/categoryIcon.png",p=32,q=32;e.PermissionEntityControl=m;function m(b,H,A,L,B,F,E){var w=this,G,r,h,s,y,m,t;w.getIcId=function(){return G};w.icReady=function(d){var c=d.html;s.html(c);if(!B){var b=a(".c_ic_frame_clip",h);b.attr("title",r)}};w.loadDefaultIc=function(){x(null,b.email,b.id,b.did,b.name,s)};w.render=function(){t=b.type==f.GroupOwned;h=a('<li class="ips_entity"><div class="ips_ic"></div><a class="ips_ic_remove" href="#" onclick="return false;"></a><div class="ips_ic_details"><div class="ips_ic_name"></div><div class="ips_ic_role"></div></div><div class="c_clr"></div></li>');d(h,"$Sutra.SkyDrive.InfoPaneSharingEntity");L.append(h);s=a(".ips_ic",h);if(t)h.addClass("ips_group");else K(b);if(B){if(!t){if(F&&b.role!=g.Owner)N();R()}S()}};function S(){var c=a(".ips_ic_details .ips_ic_role",h);if(!C()){h.addClass("ips_link_entity");c.remove();return}var j=b.role;d(c,"$Sutra.SkyDrive.InfoPaneSharingEntityRole");if(!F||j==g.Owner||!FilesConfig.isDependentOnNewStorageInterface&&b.type==f.Link||!FilesConfig.fullPermissions&&b.type==f.Link&&b.linkType==i.Network){c.text(u(j));v(c,u(j))}else{var e=g;if(t)e=l;m=a("<select></select>");c.append(m);v(m,u(j));var n=u(e.View),p=a('<option value="'+e.View+'"></option>').text(n);m.append(p);var k=u(e.Edit),o=a('<option value="'+e.Edit+'"></option>').text(k);m.append(o);if($B.IE&&$B.V<9){v(p,n);v(o,k)}m.val(j);m.bind("change click keyup",M)}}function M(){var a=m.val();if(a!=b.role){z();y=b.role;b.role=a;A.updatePermissions(H,b,{suppressNotification:true},J,I)}}function J(){E.render()}function I(){b.role=y;var d=a('<div class="ips_error"></div>');h.prepend(d);D(d,c("Sharing.EditPermissionsFailure"));m.val(y)}function R(){var c=a(".ips_ic_details .ips_ic_name",h);c.text(b.name);c.attr("type",b.type);if(C())v(c,b.name);d(c,"$Sutra.SkyDrive.InfoPaneSharingEntityName")}function v(a,b){a.attr("title",b)}function N(){var e=a(".ips_ic_remove",h),b=c("Sharing.DeletePermission"),f=a('<div class="ips_grey_remove"></div>').append(j.getImage("ppGreyX",b,b)),g=a('<div class="ips_red_remove"></div>').append(j.getImage("ppRedX",b,b));d(e,"$Sutra.SkyDrive.InfoPaneSharingEntityRemove");e.append(f);e.append(g);e.click(O)}function z(){a(".ips_error",h).remove()}function O(){z();A.deletePermission(H,b,Q,P)}function P(){z();var b=a('<div class="ips_error"></div>');h.prepend(b);D(b,c("Sharing.EditPermissionsFailure"))}function Q(){E.render()}function K(b){var g=b.name,d=b.type,h=b.did,e=b.icon;r=g;if(d==f.User)G=o+b.id;else if(d==f.Email)w.loadDefaultIc();else if(d==f.Group&&!b.icon)x(n,r,b.id,h,g,s);else if(d==f.Group)x(b.icon,r,b.id,h,g,s);else if(d==f.Link||d==f.Public||d==f.Friends){var c;if(e&&e.url){c=a("<img/>");c.attr("src",e.url);c.attr("height",p);c.attr("width",q)}else{var k=d==f.Link?b.linkType!=i.Embed?"linkIcon":"embedIcon":d==f.Friends?"friendsIcon":"publicIcon";c=a(j.getImage(k,r,r))}c.addClass("ips_ic_icon");c.attr("alt",r);c.attr("title",r);s.append(c)}}function x(f,d,i,g,h,b){var j=$ic.ic.createICFromTemplate(k,0,0,0,k,i,g,h,0,0,f,0,0,0,1,0),e=j.html;b.html(e);var c=a(".c_ic_frame_clip",b);c.attr("title",d)}function C(){var a=b.type;return !(a==f.Link&&b.linkType!=i.Network||a==f.Public)}function u(b){var a="CanView";if(t){if(b==l.Edit)a="CanEdit";a="GroupMembers"+a}else if(b==g.Edit)a="CanEdit";else if(b==g.Owner)a="Owner";return c("Sharing."+a)}function D(b,c){var a=new e.InlineError(b,c);a.render()}}})();(function(){var g="SharingListTemplate",j="SharingListExpandedTemplate",t="sharingListIc",p=100,q=1e3,m=5,n=12,s=b.PermissionsProvider,l=b.CommandManager;e.SharingList=r;function r(B,v,C,y){var z=this,r=y.fe,E=y.fe,t,w,x,A,b,s=false;z.render=function(a){a=a||b;var c=u(a,b,o);if(!c)r=y.fe;b=a;clearTimeout(A);clearTimeout(x);if(c)G();else A=setTimeout(G,p)};function G(){x=setTimeout(function(){O()},q);M()}z.dispose=function(){clearTimeout(x);clearTimeout(A);if(s){$ic.ic.removeICsFromNamespace(g);$ic.ic.removeICsFromNamespace(j);s=false}};function M(){C.fetchPermissions(b,N,J)}function O(){if(s){$ic.ic.removeICsFromNamespace(g);$ic.ic.removeICsFromNamespace(j);s=false}w=null;v.empty();var a=new f.Controls.LoadingSpinner(v);a.render()}function N(l,d){if(l.id!=b.id)return;clearTimeout(x);clearTimeout(A);if(P(d)){F(a(".ips_commands",v));w=d;return}w=d;E=r;t=a("<div></div>");t.insertAfter(v).hide();var k=a('<div class="ips_commands"></div>');F(k);t.append(k);var o=FilesConfig.hcid,i=o==l.ownerCid,e=d.permissionScopes;if(s){$ic.ic.removeICsFromNamespace(g);$ic.ic.removeICsFromNamespace(j);s=false}if(i&&e&&e.length==1&&e[0].entities&&e[0].entities.length==0){var n=b.folder?c("Sharing.PrivateFolder"):c("Sharing.PrivateFile");D(n);H();return}var f=K(d);if(f<=m)r=true;s=true;L(d,i);I(d,f);var h=d.sharingLevel;if(h)D(h);H()}function F(d){d.empty();var c=l.produceCommandList(B,l.getCommands(l.commandLists.Sharing),b,null,{bici:B.infoPaneBiciLoc,fs:y.fs(b)});for(i=0;i<c.length;i++){var e=a('<div class="ipc_container"></div>').append(c[i]);d.append(e)}}function H(){t.show();v.remove();d(t,"$Sutra.SkyDrive.InfoPaneSharing");v=t}function P(a){if(!a||!w||a.permissionScopes.length!=w.permissionScopes.length)return k;if(a.permissionScopes.length&&a.permissionScopes[0].id==b.id&&a.permissionScopes[0].entities.length||a.permissionScopes.length==1&&a.permissionScopes[0].entities&&a.permissionScopes[0].entities.length==0)return k;for(var c=0;c<a.permissionScopes.length;c++)if(Object.toJSON(a.permissionScopes[c].entities)!=Object.toJSON(w.permissionScopes[c].entities))return k;if(E!=r)return k;return o}function R(){r=true;z.render()}function Q(){r=false;z.render()}function I(f,e){if(!y.fe&&e>m){var b=a('<a href="#" onclick="return false;"></a>');t.append(b);if(!r){b.addClass("ips_expand");b.text(c("Sharing.ViewAll"));d(b,"$Sutra.SkyDrive.InfoPaneSharingViewAll");b.click(R)}else{b.addClass("ips_collapse");b.text(c("Sharing.CollapseAll"));d(b,"$Sutra.SkyDrive.InfoPaneSharingCollapse");b.click(Q)}}}function L(m,p){var c=a('<ul class="ips_list"></ul>');d(c,"$Sutra.SkyDrive.InfoPaneSharingScopes");c.addClass(r?"ips_extended":"ips_quick");t.append(c);var s=[],j=0,e=m.permissionScopes,k=e.length;for(var i=0;i<k;i++){var g=e[i],q=m.canChange&&h(g.id,b.id),l=n-j;if(g.entities.length&&(l>0||r)){var o=new f.Controls.PermissionScopeControl(B,C,c,b,g,!p,r,q,z);o.render(l);j+=g.entities.length}}if(k>1&&e[0].entities&&e[0].entities.length==0)a("li:first-child",c).addClass("ips_scope_first");c.append(a('<div class="c_clr"></div>'))}function D(c){var b=a("<div></div>").text(c);d(b,"$Sutra.SkyDrive.InfoPaneSharingSimpleSharingLevel");t.append(b)}function K(c){var b=0;for(var a=0;a<c.permissionScopes.length;a++){var d=c.permissionScopes[a];b+=d.entities?d.entities.length:0}return b}function J(h){if(h.id!=b.id)return;if(s){$ic.ic.removeICsFromNamespace(g);$ic.ic.removeICsFromNamespace(j);s=false}v.empty();clearTimeout(x);var i=c("Sharing.GetPermissionsError"),d=a('<div class="ips_error"></div>');v.append(d);var f=new e.InlineError(d,i);f.render()}}$Do.register("SharingList")})();(function(){var i=3,g={Email:1,Network:2,Link:3};h.Panes=g;var j='<div class="sd_pop_body"><ul class="sd_menu"><li class="sd_menu_tab sd_menu_selected"><a href="#" class="sd_menu_sendemail" onclick="return false"></a></li><li class="sd_menu_tab"><span class="sd_menu_oh"><a href="#" class="sd_menu_postto" onclick="return false"></a></span></li><li class="sd_menu_tab"><a href="#" class="sd_menu_getlink" onclick="return false"></a></li></ul><div class="sd_contents"><div class="sd_loading"></div><div class="sd_content"></div></div><div class="c_clr"></div><a class="sd_close" href="#" onclick="return false;"></a></div>';e.ShareDialog=h;function h(E,s,w,I){var h=this,K,k,p=g.Email,B=new b.NetworksProvider,D=false,n,l,o,m,C,L,q,z,F,u,G,r="sd_menu_disabled",A="sd_menu_selected";h.render=function(){if(!D){var b=a(j);d(b,"$Sutra.SkyDrive.ShareDialog");m=a(".sd_menu",b);d(m,"$Sutra.SkyDrive.ShareDialogMenu");C=a(".sd_menu_sendemail",m).text(c("Sharing.SendEmail")).parent().click(function(){t(this,g.Email)});_$getALinkTab=a(".sd_menu_getlink",m).text(c("Sharing.GetALink")).parent().click(function(){t(this,g.Link)});q=a(".sd_menu_postto",m).text(c("Sharing.PostToLink")+" ").parent().parent().click(function(){t(this,g.Network)});z=a(".sd_menu_oh",q);F=a(".sd_menu_tab",m);d(C,"$Sutra.SkyDrive.ShareDialogMenuEmailPaneTab");d(_$getALinkTab,"$Sutra.SkyDrive.ShareDialogMenuLinkPaneTab");d(q,"$Sutra.SkyDrive.ShareDialogMenuNetworkPaneTab");l=a(".sd_loading",b);n=a(".sd_content",b);l.hide();var i=c("Sharing.Close");o=a(".sd_close",b);o.append(f.Core.ImageStrip.getImage("close",i,i));o.click(h.close);d(o,"$Sutra.SkyDrive.ShareDialogCloseButton");b.bind(v,J);E.append(b);if(!FilesConfig.managedAccount)B.fetchNetworks(H);else{_$getALinkTab.hide();q.hide()}D=true}if(k)k.dispose();n.empty();if(p==g.Link)k=new e.LinkPane(n,s,w,h);else if(p==g.Network)k=new e.NetworkPane(n,s,B,w,h);else k=new e.EmailPane(n,s,w,h);k.render(u)};h.setVisiblePane=function(a){if(a!=p){u=k.getUserMessage&&k.getUserMessage()||u;p=a;h.render()}};h.close=function(){k.dispose();I();E.empty();G=true};h.showLoading=function(c){l.empty();var b=new f.Controls.LoadingSpinner(l,c);b.render();l.show();var a=(n.height()-l.height())/2;l.css("padding-top",Math.ceil(a));l.css("padding-bottom",Math.floor(a));n.hide();o.hide()};h.hideLoading=function(){l.hide();n.show();o.show()};h.enableMenuTabs=function(){m.removeClass(r)};h.disableMenuTabs=function(){m.addClass(r)};function t(b,c){if(!m.hasClass(r)){F.removeClass(A);a(b).addClass(A);h.setVisiblePane(c)}}function J(b){var a=b.which;if(a==27){h.close();return false}else if(a==37||a==38||a==39||a==40)return false}function H(j){if(!G){var g=j,f=Math.min(g.length,i);if(f>0){var c=a("<span></span>");d(c,"$Sutra.SkyDrive.NetworkIcons");for(var e=0;e<f;e++){var h=g[e],b=a('<img width="16" height="16" />');d(b,"$Sutra.SkyDrive.NetworkIcon");b.attr(y,h.iconSmall);b.attr(x,h.name);c.append(b)}z.append(c)}}}}$Do.register("wLive.Controls.ShareDialog")})();(function(){var j=0,k=3006,i=20,l='<h2 class="sd_header"></h2><form><div><div class="sd_email_to_label"></div><div class="sd_email_to_line"></div><div class="c_clr"></div></div><div class="sd_email_error"></div><textarea class="sd_email_message"></textarea><div class="sd_email_can_edit"><input id="sd_email_can_edit" type="checkbox" checked="checked" /><label for="sd_email_can_edit"></label></div><div class="sd_email_signin_req"><input id="sd_email_signin_req" type="checkbox" /><label for="sd_email_signin_req"></label></div><input class="sd_email_share" type="button" /></form>',h=c("Sharing.PersonalMessagePlaceholder"),g,f;e.EmailPane=m;function m(m,B,v,s){var o,G,r,p,A,y,q,w,u,x=this;x.render=function(b){w=b;if(!g){g=a("#SD_ContactPicker");f=new Microsoft.Live.ContactPicker.AutoComplete("MyAutoComplete");f.autoExpandCategories=true}setTimeout(E,0)};x.getUserMessage=function(){var a=q&&q.val();return !a||a==h?null:a};x.dispose=function(){u=true};function E(){if(u)return;f.attachEvent("onContactAdded",t);f.attachEvent("onContactRemoved",t);f.attachEvent("onCategoryExpand",t);setTimeout(function(){f.deleteAllElements()},0);d(m,"$Sutra.SkyDrive.ShareDialogEmailPane");m.html(l);var k=v.extension,n=a(".sd_header",m);n.text(c("Sharing.EmailShareHeaderFormat").format(v.name+(k?k:"")));d(n,"$Sutra.SkyDrive.EmailPaneHeader");p=a(".sd_email_error",m);var j=a(".sd_email_to_label",m).text(c("Sharing.ToLabel"));o=a(".sd_email_to_line",m);var B=m.width()-j.width()-15;o.width(B);g.remove();o.append(g);g.show();a("textarea",g).focus();d(a(".InputBox",o),"$Sutra.SkyDrive.EmailPaneToLine");setTimeout(function(){var c=(o.height()-j.height())/2;j.css("padding-top",c);var b=o.width();o.css("overflow","visible");o.css("float",$B.ltr?"left":"right");o.width(b);a(".SelectContainer",o).width(b-2);var d=m.parent().closest(".Body").css("overflow","visible");m.hide().show()},0);q=a(".sd_email_message",m);var x=new e.PlaceholderInput(q,h);x.render();d(q,"$Sutra.SkyDrive.EmailPaneMessageInput");w&&q.val(w);var i=a(".sd_email_can_edit",m),b=a(".sd_email_signin_req",m);A=a("#sd_email_can_edit",i);y=a("#sd_email_signin_req",b);r=a(".sd_email_share",m);d(i,"$Sutra.SkyDrive.EmailPaneRecipientsCanEdit");d(b,"$Sutra.SkyDrive.EmailPaneRecipientsMustSignIn");d(r,"$Sutra.SkyDrive.EmailPaneShare");a("label",i).text(c("Sharing.RecipientsCanEdit"));a("label",b).text(c("Sharing.SignInRequired"));r.val(c("Sharing.Share"));r.click(F);var z=m.height();m.css("min-height",z);f.setFocus();s.hideLoading()}function t(){var b=f.selectedAbchElements.length,a=b>i,d=a?c("Sharing.MaxContacts").format(i):"";if(a)r.attr(n,n);else r.removeAttr(n);z(d)}function z(a){p.empty();if(a){var b=new e.InlineError(p,a);b.render();p.show()}else p.hide()}function F(){z();s.showLoading(c("Sharing.SharingFormat").format(v.name));s.disableMenuTabs();var e=A.attr("checked")?b.PermissionsProvider.Role.Edit:b.PermissionsProvider.Role.View,d=!!y.attr("checked"),a=q.val();a=a==h?null:a;p.empty();p.hide();B.shareToContacts(v,f.selectedAbchElements,e,d,a,D,C)}function C(B,b,g){if(u)return;var a=b.message,n=false;if(!a&&g){var v=0,x=0;for(var m=0;m<g.length;m++){var i=g[m],h=i.entity;if(i.status&&i.status!=j)v++;else{x++;var o=f.selectedAbchElements;for(var l=0;l<o.length;l++){var d=o[l];if(h.did==d.serverSideContactID||h.abId==d.serverSideID||h.email==d.email){f._removeContact({UniqueSelectedElementID:d._uniqueSelectedElementID,FireEvent:false});break}}}}if(x==0)a=c("Sharing.ShareErrorAllFailed");else a=c("Sharing.ShareErrorSomeFailed").format(v)}if(b&&b.code==k){var z=b.data,r=b.message;if(z&&r){var w=Object.fromJSON(z),q=w.displayAction,y=w.hipUrl;if(y&&q){a=r.encodeHtml()+' <a href="'+y.encodeHtmlAttribute()+'" target="_blank">'+q.encodeHtml()+"</a>";n=true}}}t();var A=new e.InlineError(p,a,n);A.render();p.show();s.hideLoading();s.enableMenuTabs()}function D(){if(u)return;s.close()}}})();(function(){var k=0,i=3101,l=5,m=5,f=c("Sharing.PersonalMessagePlaceholder"),h=b.NetworksProvider.Status;e.NetworkPane=n;function n(x,G,z,A,o){var D=this,s,w=0,q={},p,t,C,n,r,u,y;D.render=function(h){var i=A.extension;d(x,"$Sutra.SkyDrive.ShareDialogNetworkPane");var j=a('<h2 class="sd_header"></h2>').text(c("Sharing.NetworkPostHeaderFormat").format(A.name+(i?i:"")));d(j,"$Sutra.SkyDrive.NetworkPaneHeader");r=a('<div class="sd_post_error"></div>');r.hide();p=a('<div class="sd_net_line"></div>');n=a('<textarea class="sd_post_message"></textarea>');var k=new e.PlaceholderInput(n,f);k.render();d(n,"$Sutra.SkyDrive.NetworkPaneMessageInput");h&&n.val(h);var g=a('<div><input id="sd_post_can_edit" type="checkbox" /><label for="sd_post_can_edit"></label></div>');C=a("input",g);a("label",g).text(c("Sharing.RecipientsCanEdit"));d(C,"$Sutra.SkyDrive.NetworkPaneRecipientsCanEdit");u=a('<input class="sd_post_share" type="button" />');u.val(c("Sharing.Post"));u.click(O);d(u,"$Sutra.SkyDrive.NetworkPanePost");var b=a("<form></form>");b.append(r);b.append(p);b.append(n);if(FilesConfig.fullPermissions)b.append(g);b.append(u);x.append(j);x.append(b);o.showLoading();z.fetchNetworks(N,J)};D.getUserMessage=function(){var a=n&&n.val();return !a||a==f?null:a};D.dispose=function(){y=true};function O(){var d=[];for(var g in q)d.push(q[g]);o.showLoading(c("Sharing.PostingFormat").format(A.name));o.disableMenuTabs();var e=C.attr("checked")?b.PermissionsProvider.Role.Edit:b.PermissionsProvider.Role.View,a=n.val();a=a==f?null:a;r.empty();r.hide();G.shareToNetworks(A,d,e,a,M,L)}function L(x,v,g){if(y)return;var f=v.message;if(g){var n=0,p=0;for(var m=0;m<g.length;m++){var a=g[m],j=a.entity;if(a.status&&a.status!=k){n++;if(a.errorCode&&a.errorCode==i)for(var l=0;l<s.length;l++){var b=s[l];if(b.id==j.linkName){var d=a.uniqueError;b.status=h.Error;if(d&&d.data){var u=Object.fromJSON(d.data);b.connectLink=u.url}delete q[j.linkName];w--;break}}}else{p++;delete q[j.linkName];w--}}if(p==0)f=c("Sharing.PostErrorAllFailed");else f=c("Sharing.PostErrorSomeFailed").format(n)}B();E();var t=new e.InlineError(r,f);t.render();r.show();o.hideLoading();o.enableMenuTabs()}function M(){if(y)return;o.close()}function N(l){if(y)return;o.hideLoading();s=z.getConnectedNetworks(l);var e=z.getUpsellNetworks(l),b;if(s.length==0){var m=c("Sharing.NoneConnectedUpsellFormat").format('<a class="c_ml" href="#" onclick="return false;">',"</a>"),h=a('<span class="sd_net_upsell"></span>').html(m);d(h,"$Sutra.SkyDrive.NetworkPaneNoNetworksUpsell");b=a("a",h);p.append(h)}else{t=a('<ul class="sd_post_netlist"></ul>');d(t,"$Sutra.SkyDrive.NetworkIcons");E();p.append(t);var i=a('<div class="sd_post_uplink"></div>');if(e.length>0){b=a('<a class="c_ml" href="#" onclick="return false;"></a>').text(c("Sharing.ConnectMenu"));b.append(a('<span class="c_chev">&nbsp;&#9660;</span>'))}else{b=a('<a class="c_ml" target="_blank"></a>').text(c("Sharing.ManageMyServices"));b.attr("href",g.FilesConfig.manageServicesUrl);b.bind(j,v)}i.append(b);p.append(i);p.append('<div class="c_clr"></div>')}if(e.length>0){var f=K(e);p.append(f);d(b,"$Sutra.SkyDrive.NetworkPaneConnectMenuLink");d(f,"$Sutra.SkyDrive.NetworkPaneConnectMenu");var k=0;b.click(function(a){if(!k)$menu.create(a,1,{menuEl:f[0]});k=1})}B();n.focus()}function v(){z.clearCache();o.close()}function E(){t.empty();var b=s.length,c=Math.min(l,b);for(var a=0;a<c;a++){var d=s[a],e=F(d);t.append(e)}t.append('<div class="c_clr"></div>')}function F(e){var k=a('<li class="sd_post_netop"></li>'),f=a('<input type="checkbox" />'),l=a("<label></label>"),i=a("<img />");i.attr("alt",e.name);i.attr("src",e.iconSmall);var n="sd_net_box_"+e.id;if(e.status==h.Error){f.attr("disabled","disabled");var m=c("Sharing.NetworkErrorTooltipFormat").format(e.name);i=a('<a target="_blank" href="#"></a>').append(i).append(b.ImageStrip.getImage("warning",m,m));i.bind(j,{msg:e.connectLink?e.connectLink:g.FilesConfig.manageServicesUrl},I)}else if(q[e.id])f.attr("checked","on");f.attr("id",n);l.attr("for",n);l.append(i);k.append(f);k.append(l);d(f,"$Sutra.SkyDrive.NetworkIcon");f.click(function(){if(f.attr("checked")){q[e.id]=e;w++}else{delete q[e.id];w--}B()});return k}function B(){var a=w==0?"disabled":"";u.attr("disabled",a)}function K(i){var o=Math.min(m,i.length),b=a('<ul class="c_m t_hovl"></ul>');for(var l=0;l<o;l++){var d=i[l],n=a('<li class="sd_post_upsell"></li>'),e=a('<a href="#" target="_blank"></a>'),k=a('<img class="sd_post_upicon" />');k.attr("alt",d.name);k.attr("src",d.iconSmall);e.bind(j,{msg:d.addLink},H);e.append(k);e.append(a("<span></span>").text(d.name));n.append(e);b.append(n)}var f=a('<a target="_blank"></a>').text(c("Sharing.FindMoreServices")),h=a('<a target="_blank"></a>').text(c("Sharing.ManageMyServices"));f.attr("href",g.FilesConfig.findServicesUrl);f.bind(j,v);h.attr("href",g.FilesConfig.manageServicesUrl);h.bind(j,v);if(i.length>0)b.append('<li class="c_ms"></li>');b.append(a("<li></li>").append(f));b.append(a("<li></li>").append(h));return b}function H(b){var a=b.data.msg+"&view=popup&brand=skydrive&scenarios=status_publish&biciid=skydrivepub&closenoredirect=true";window.open(a,"addNetwork","width=450px,height=525px,status=no,toolbar=no,resizeable=yes,menubar=no,scrollbars=yes",true);v();return false}function I(b){var a=b.data.msg;window.open(a,"fixNetwork","width=450px,height=525px,status=no,toolbar=no,resizeable=yes,menubar=no,scrollbars=yes",true);v();return false}function J(b){if(y)return;o.hideLoading();x.empty();var a=new e.InlineError(x,b.message);a.render()}}})();(function(){var i=b.PermissionsProvider,j=i.Role,k=".sd_focusable";e.LinkPane=l;function l(o,n,b,w){var y=this,l,s,r,x,v,u,q,m;y.render=function(){var e=b.extension;d(o,"$Sutra.SkyDrive.ShareDialogLinkPane");var f=a('<h2 class="sd_header"></h2>').text(c("Sharing.GetLinkHeaderFormat").format(b.name+(e?e:"")));o.append(f);d(f,"$Sutra.SkyDrive.LinkPaneHeader");l=a("<div></div>");o.append(l);d(l,"$Sutra.SkyDrive.LinkSections");if(!n.hasCachedData(b))w.showLoading();n.fetchPermissions(b,B,z)};y.dispose=function(){m=true};function B(k,j){if(m)return;var e=j.permissionScopes;for(var c=0;c<e.length;c++){var f=e[c],g=h(f.id,k.id),d=f.entities;for(var b=0;b<d.length;b++){var a=d[b];if(g&&a.type==i.EntityType.Link){if(a.linkType==i.LinkType.View)v=a;else if(a.linkType==i.LinkType.Edit)u=a}else if(a.type==i.EntityType.Public)q=a}}A()}function A(){w.hideLoading();l.empty();s=t(j.View,v,c("Sharing.ViewLinkTitle"),c("Sharing.ViewLinkDescription"));if(FilesConfig.fullPermissions)r=t(j.Edit,u,c("Sharing.EditLinkTitle"),c("Sharing.EditLinkDescription"));x=t(-1,q,c("Sharing.PublicViewLinkTitle"),c("Sharing.PublicViewLinkDescription"));var b=s;if(v)b=s;else if(u&&r)b=r;else if(q)b=x;a(k,b).focus()}function z(){if(m)return;w.hideLoading();var b=a("<div></div>");o.append(b);var d=new f.Controls.InlineError(b,c("Sharing.GetPermissionsError"));d.render()}function t(k,i,j,h){var c=a("<div></div>");d(c,"$Sutra.SkyDrive.LinkSection");var e=a("<div></div>");d(e,"$Sutra.SkyDrive.LinkHeader");var g=a('<div class="sd_link_title"></div>').text(j),f=a('<div class="sd_link_desc"></div>').text(h);e.append(g);d(g,"$Sutra.SkyDrive.LinkSectionTitle");e.append(f);d(f,"$Sutra.SkyDrive.LinkSectionDescription");c.append(e);var b=a("<div></div>");d(b,"$Sutra.SkyDrive.LinkHolder");c.append(b);l.append(c);p(k,i,b);return b}function p(m,k,f,l){f.empty();if(l){var n=new e.InlineError(f,l);n.render()}if(!k){var h=a('<input class="sd_create_button sd_focusable" type="button" />').val(c("Sharing.CreateLink"));h.click(function(){C(m,f)});f.append(h);d(h,"$Sutra.SkyDrive.CreateLinkButton")}else{var j;if(m==-1)j=g.FilesConfig.sharingBaseUrl+"?cid="+b.ownerCid.toLowerCase()+"&resid="+b.id+"&parid="+b.parentId;else j=k.link;var i=a('<input class="sd_link_display sd_focusable" type="text" readonly="true" value="'+j.encodeHtmlAttribute()+'" />');f.append(i);d(i,"$Sutra.SkyDrive.LinkSectionLink");f.bind("click focus",function(){i.select()})}}function C(d,c){c.empty();var h=new e.LoadingSpinner(c,"");h.render();if(d==-1)n.makePublic(b,g,f);else n.createLink(b,d,g,f);function g(e,b){if(m)return;p(d,b,c);a(k,c).focus()}function f(b,a){if(m)return;p(d,0,c,a.message)}}}})()})();(function(){var d=window,a=d.jQuery,i=d.wLive.PageStats,p=a(i),f=i.d,j=true,q=false,h=-1,r,s,y=300,b,e,c,n,m,l,g,x;function K(){var f='<div id="pageStats"><div class="ps_m"></div><div class="ps_b"></div></div>';b=a(f);e=b.find(".ps_m");c=b.find(".ps_b").hide();var d={position:"fixed",top:0,"z-index":1e9};d[$B.rtl?"right":"left"]=0;b.css(d);a("body").append(b);G()}function G(){e.css({"background-color":"#CCC",padding:"4px"});e.bind("click",B);p.bind("go",k);k();if($Cookie.getCookie("pagestats")=="2")b.hide();a(document).bind("keydown",z)}function z(a){if(a.which==80&&a.altKey&&a.ctrlKey)if($Cookie.getCookie("pagestats")=="2")I();else w()}function w(){$Cookie.setCookie("pagestats","2",$Config.sd,"/");b.hide()}function I(){$Cookie.setCookie("pagestats","1",$Config.sd,"/");b.show()}function k(){if(j){var a=f.length,b="N/A";if(a>0)b="("+a+") "+f[a-1].clientLength/1e3+"s";e.text(b)}}function B(){j=false;e.hide();c.show();H();u()}function o(){j=true;e.show();c.hide();k()}function H(){if(!q){q=true;p.bind("go",u);var d='<a class="close" href="#" onclick="return false">X</a><a class="shrink" href="#" onclick="return false">-</a> <div class="title">Page Stats <a href="http://windows/live/5/Wiki/WCSPerformance.aspx" target="_blank">Wiki</a> : <a class="copy" href="#" onclick="return false">Copy</a> : <a class="clear" href="#" onclick="return false">Clear</a></div><div class="data"></div>';c.html(d);l=c.find(".shrink");m=c.find(".close");n=c.find(".title");g=c.find(".data");x=c.find(".copy");_$clear=c.find(".clear");var b="1px solid #CCC";c.css({"background-color":"#EEE",border:b});n.css("padding","3px");n.bind("mousedown",E);l.css({"float":"right",padding:"3px"});l.bind("click",o);m.css({"float":"right",padding:"3px"});m.bind("click",J);x.bind("click",F);_$clear.bind("click",D);g.width(y+16).css({"border-top":b,"max-height":"250px","background-color":a("body").css("background-color"),"white-space":"nowrap","font-size":"90%",padding:"4px",overflow:"auto"})}}function J(){alert("To toggle page stats press ctrl + alt + p");o();w()}function E(c){r=c.clientX-parseInt(b.css("left"));s=c.clientY-parseInt(b.css("top"));a("body").bind("mousemove",t);a("body").bind("mouseup",v);return false}function t(c){var d=a(c);b.css({top:c.clientY-s,left:c.clientX-r})}function v(){a("body").unbind("mousemove",t);a("body").unbind("mouseup",v)}function A(d){var a=d,c=a.indexOf("?");if(c>-1)a=a.substr(0,c);var b=a.lastIndexOf("/");if(b>-1&&b==a.length-1)a=a.substr(0,b);b=a.lastIndexOf("/");if(b>-1)a=a.substr(b+1);if(a.endsWith(".live-int.com"))a=a.substr(0,a.length-".live-int.com".length);else if(a.endsWith(".live.com"))a=a.substr(0,a.length-".live.com".length);return a}function D(){i.d=f=[];h=-1;g.html("<div></div>")}function F(){var a,b="User email: "+d.$Config.email+"\n"+"User cid: "+d.$Config.cid+"\n"+"User ip: "+d.$Config.ip+"\n"+"Build: "+d.$Config.build+"\n"+"Machine: "+d.$Config.mmn+"\n"+g.text();if(d.clipboardData&&d.clipboardData.setData)a=window.clipboardData.setData("Text",b);if(!a)alert("Press Ctrl+C\n Page stats data: "+b)}function u(){if(!j){var z=f.length;while(h<z-1){h++;var b=f[h],I=(b.clientStart-i.o)/1e3,l=b.clientLength/1e3,c=(b.executionTimeMs||0)/1e3,v=(b.schedulerTimeMs||0)/1e3,u="Scheduler Time: "+v+"sec";if(b.hasSchedulerTimedOut)u+=" (Timed out)";var m=b.url,B=A(m),r=Math.round((l-c)*1e3)/1e3,w=Math.round(Math.max(0,c-v)*1e3)/1e3,D=r>0?l+"s":"Cached",E=b.clientTime.localeFormat?b.clientTime.localeFormat():b.clientTime.toLocaleTimeString?b.clientTime.toLocaleTimeString():"N/A",n='<div style="display:none">------------------------------------------------------\n</div><div class="stat" style="width:'+y+'px;overflow:hidden;">'+'<a href="#" onclick="return false" class="time">'+B.encodeHtml()+" Browser: "+D+" Server: "+c+"s\n</a>"+'<div class="details" style="position: relative;">'+(b.error?"<div>Error: "+b.error.encodeHtml()+"\n</div>":"")+(b.info?"<div>Info: "+b.info.encodeHtml()+"\n</div>":"")+"<div>Browser Time: "+E+"\n</div>"+(r>0?"<div>Network (browser): "+r+"s\n</div>":"<div>Cache lookup time: "+l+"\n</div>")+(w!=0?"<div>Server Init/Rendering time: "+w+"s\n</div>":"")+'<div class="ps_ex">'+u+"\n</div>"+'<div class="ps_url" title="'+m.encodeHtmlAttribute()+'">Url: '+m.encodeHtml()+"\n</div>",s=b.tasks;if(s){var o=0,F=s.length;for(;o<F;o++){var d=s[o],t=(d.relativeStartTime||0)/1e3,x=(d.time||0)/1e3,H=Math.floor(100*t/c),p=Math.floor(100*x/c);p=Math.max(1,p);var e=d.name+" ("+x+"s)",k="B6CED8";if(d.isTimeout){e+=" Timed out";k="F30000"}if(d.isError){e+=" Errored";k="F30000"}var G="margin-left:"+H+"%;width:"+p+"%;overflow:hidden;background-color:#"+k+";height:8px";n+='<div title="'+e.encodeHtmlAttribute()+'" style="padding-bottom: 1px; background-color: #F3F7FD">'+'<div class="taskName" >'+e.encodeHtml()+"</div>"+'<div style="display:none"> Relative start: '+t+"s\n</div>"+'<div class="task" style="'+G+'" >&nbsp;</div>'+"</div>"}}n+="</div></div>";var q=a(n);q.find(".details").hide();q.find(".time").bind("click",C);g.append(q)}}}function C(c){var b=a(c.target);b.next().toggle("slow")}if(d.$Config&&d.$Config.pageStats)a(document).ready(K)})()